{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
{% endblock %}

{% block content %}
    <form id="csrf-form">
      {% csrf_token %}
    </form>

    <style>
      * {
        padding: 0;
        margin: 0;
        box-sizing: border-box;
      }
body{
    overflow: hidden;
}
      .conatner_ai_head {
        width: 100%;
        height: 3rem;
      }
      .ai_chat_container {
        width: 100%;
        height: auto;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        position: relative;
      }

      /* Sidebar chiziq */
      .sidebar-line {
        position: fixed;
        left: 15%;
        top: 80px;
        bottom: 20px;
        width: 3px;
        background: linear-gradient(
          to bottom,
          rgba(5, 130, 171, 0.3),
          rgba(23, 162, 184, 0.3),
          rgba(5, 130, 171, 0.3)
        );
        border-radius: 2px;
        z-index: 900;
      }

      /* Header qismi */
      .header_chat {
        margin: 0 auto;
        width: 100%;
        height: auto;
          border-radius: 0 0 20px 20px;
          padding: 10px 0;
      }

      .head_box {
        width: 50%;
          margin: 0 auto;
        height: auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        top: 10px;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo h1 {
        font-size: clamp(1.3rem, 2vw, 2.2rem);
        font-weight: 700;
        margin: 0;
        background: linear-gradient(
          45deg,
          rgba(5, 130, 171, 0.9),
          rgba(23, 162, 184, 0.9)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .logo .fa-robot {
        font-size: clamp(1.5rem, 2.5vw, 2.5rem);
        background: linear-gradient(
          45deg,
          rgba(5, 130, 171, 0.9),
          rgba(23, 162, 184, 0.9)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .btn_box {
        display: flex;
        gap: 12px;
        align-items: center;
        position: relative;
      }

      .btn_box button {
        border: none;
        background: linear-gradient(
          45deg,
          rgba(5, 130, 171, 0.9),
          rgba(23, 162, 184, 0.9)
        );
        padding: clamp(8px, 1.5vw, 12px) clamp(12px, 2vw, 24px);
        border-radius: 12px;
        color: white;
        width: auto;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 15px rgba(5, 130, 171, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        font-size: clamp(0.8rem, 1vw, 1rem);
      }

      .btn_box button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(5, 130, 171, 0.3);
        background: linear-gradient(
          45deg,
          rgba(5, 130, 171, 1),
          rgba(23, 162, 184, 1)
        );
      }

      /* Story list - YAXSHILANGAN */
      .story_list {
        position: fixed;
        width: clamp(18rem, 25vw, 22rem);
        height: auto;
        max-height: 70vh;
        backdrop-filter: blur(15px);
        background: rgba(255, 255, 255, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.4);
        top: 80px;
        right: 20px;
        border-radius: 20px;
        display: none;
        padding: 20px;
        box-shadow: 0 10px 40px rgba(5, 130, 171, 0.25);
        z-index: 1001;
        overflow-y: auto;
        overflow-x: hidden;
      }

      .story_list.show {
        display: block;
        animation: slideInRight 0.3s ease-out;
      }

      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .story_list h3 {
        color: #2c3e50;
        font-size: clamp(1rem, 1.3vw, 1.3rem);
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid rgba(5, 130, 171, 0.2);
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
      }

      .story_list ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .story_list li {
        padding: 12px 15px;
        margin-bottom: 10px;
        background: rgba(255, 255, 255, 0.6);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        border-left: 4px solid rgba(5, 130, 171, 0.4);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        position: relative;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal;
      }

      .story_list li:hover {
        background: rgba(5, 130, 171, 0.08);
        transform: translateX(5px);
        border-left-color: rgba(5, 130, 171, 0.8);
        box-shadow: 0 4px 12px rgba(5, 130, 171, 0.15);
      }

      .story_list li .delete-chat {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(220, 53, 69, 0.1);
        border: none;
        color: #dc3545;
        width: clamp(24px, 2vw, 28px);
        height: clamp(24px, 2vw, 28px);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        opacity: 0.7;
        font-size: clamp(0.7rem, 1vw, 0.9rem);
      }

      .story_list li .delete-chat:hover {
        background: rgba(220, 53, 69, 0.2);
        opacity: 1;
        transform: translateY(-50%) scale(1.1);
      }

      .story_list li .chat-preview {
        display: block;
        font-size: clamp(0.8rem, 1vw, 0.9rem);
        color: #495057;
        margin-right: 30px;
        line-height: 1.4;
        max-height: 2.8em;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }

      .clear_history {
        width: 100%;
        background: linear-gradient(
          45deg,
          rgba(220, 53, 69, 0.9),
          rgba(220, 53, 69, 0.7)
        ) !important;
        margin-top: 20px;
        padding: 12px !important;
        font-size: clamp(0.85rem, 1vw, 0.95rem);
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
      }

      .clear_history:hover {
        background: linear-gradient(
          45deg,
          rgba(220, 53, 69, 1),
          rgba(220, 53, 69, 0.9)
        ) !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3) !important;
      }

      /* Body qismi - KENGAYTIRILGAN */
      .body_chat {
        width: 50%;
        height: auto;
        min-height: calc(100vh - 160px);
        margin: 0 auto;
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .infochat {
        text-align: center;
        height: auto;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.4);
        padding: clamp(15px, 2vw, 20px);
        backdrop-filter: blur(15px);
        background: rgba(255, 255, 255, 0.65);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      }

      .body_chat h3 {
        color: #2c3e50;
        font-size: clamp(1.4rem, 2.5vw, 2rem);
        font-weight: 700;
        margin-bottom: clamp(10px, 1.5vw, 20px);
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .body_chat p {
        color: rgba(44, 62, 80, 0.85);
        font-size: clamp(1rem, 1.2vw, 1.1rem);
        line-height: 1.7;
        margin-bottom: 0;
      }

      /* Chat message container */
      .message-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        min-height: 350px;
        max-height: calc(100vh - 260px);
        overflow-y: auto;
        padding: 15px;
        scroll-behavior: smooth;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-top: 0;
      }

      .message {
        padding: clamp(15px, 1.5vw, 18px) clamp(16px, 2vw, 20px);
        margin-bottom: clamp(15px, 1.5vw, 20px);
        border-radius: 15px;
        max-width: 85%;
        animation: fadeInUp 0.4s ease-out;
        word-wrap: break-word;
        line-height: 1.6;
        position: relative;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        font-size: clamp(1rem, 1.1vw, 1.05rem);
      }

      .user-message {
        background: linear-gradient(
          135deg,
          rgba(5, 130, 171, 0.12),
          rgba(23, 162, 184, 0.12)
        );
        border-left: 5px solid rgba(5, 130, 171, 0.8);
        margin-left: auto;
        margin-right: 0;
        backdrop-filter: blur(10px);
      }

      .ai-message {
        background: rgba(255, 255, 255, 0.7);
        border-right: 5px solid rgba(23, 162, 184, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(10px);
      }

      /* Copy button */
      .copy-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        width: clamp(28px, 2.5vw, 32px);
        height: clamp(28px, 2.5vw, 32px);
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(5, 130, 171, 0.3);
        color: rgba(5, 130, 171, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: clamp(12px, 1vw, 14px);
        opacity: 0;
        transform: translateY(-5px);
      }

      .message:hover .copy-btn {
        opacity: 1;
        transform: translateY(0);
      }

      .copy-btn:hover {
        background: rgba(5, 130, 171, 0.15);
        color: rgba(5, 130, 171, 1);
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(5, 130, 171, 0.2);
      }

      /* Scroll to bottom button */
      .scroll-to-bottom {
        position: fixed;
        bottom: clamp(90px, 10vh, 100px);
        right: 20%;
        transform: translateX(50%);
        width: clamp(36px, 3vw, 44px);
        height: clamp(36px, 3vw, 44px);
        border-radius: 50%;
        background: rgba(5, 130, 171, 0.9);
        color: white;
        border: 2px solid white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        opacity: 0;
        visibility: hidden;
        z-index: 999;
        box-shadow: 0 6px 20px rgba(5, 130, 171, 0.3);
        font-size: clamp(0.9rem, 1.2vw, 1rem);
      }

      .scroll-to-bottom.visible {
        opacity: 1;
        visibility: visible;
      }

      .scroll-to-bottom:hover {
        background: rgba(5, 130, 171, 1);
        transform: translateX(50%) translateY(-3px);
        box-shadow: 0 8px 25px rgba(5, 130, 171, 0.4);
      }

      /* Harfma-harf chiqish effekti */
      .typing-text {
        display: inline;
      }

      .typing-text span {
        opacity: 0;
        animation: typeIn 0.01s forwards;
      }

      @keyframes typeIn {
        to {
          opacity: 1;
        }
      }

      /* Kutish effekti */
      .typing-indicator {
        display: none;
        padding: clamp(15px, 1.5vw, 20px) clamp(20px, 2vw, 25px);
        backdrop-filter: blur(15px);
        background: rgba(255, 255, 255, 0.7);
        border-radius: 15px;
        width: fit-content;
        margin-bottom: clamp(15px, 1.5vw, 20px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        align-self: flex-start;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }

      .typing-indicator span {
        height: clamp(10px, 1vw, 12px);
        width: clamp(10px, 1vw, 12px);
        float: left;
        margin: 0 4px;
        background: linear-gradient(
          45deg,
          rgba(5, 130, 171, 0.8),
          rgba(23, 162, 184, 0.8)
        );
        display: block;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
      }

      .typing-indicator span:nth-child(1) {
        animation-delay: -0.32s;
      }

      .typing-indicator span:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
          opacity: 0.5;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* Footer qismi - YUQORIGA KENGAYTIRILGAN */
      .footer_chat {
        backdrop-filter: blur(10px);
        background-color: rgba(255, 255, 255, 0.511);
        width: 50%;
        margin: 0 auto;
        position: fixed;
        z-index: 50;
        bottom: clamp(15px, 2vh, 20px);
        left: 50%;
        transform: translateX(-50%);
        text-align: center;
        padding: clamp(12px, 1.5vw, 15px) 0;
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 15px;
        transition: all 0.3s ease;
        min-height: auto;
        height: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .input_cont {
        width: 90%;
        margin: 0 auto;
        text-align: start;
        position: relative;
      }

      .input_cont textarea {
        width: 100%;
        padding: clamp(15px, 1.5vw, 18px) clamp(60px, 5vw, 70px) clamp(15px, 1.5vw, 18px) clamp(15px, 1.5vw, 20px);
        border-radius: 15px;
        backdrop-filter: blur(15px);
        background: rgba(255, 255, 255, 0.7);
        color: #2c3e50;
        font-size: clamp(0.95rem, 1.1vw, 1rem);
        transition: all 0.3s ease;
        min-height: clamp(55px, 6vh, 60px);
        max-height: 35vh;
        resize: none;
        overflow-y: auto;
        font-family: inherit;
        line-height: 1.6;
        white-space: pre-wrap;
        word-wrap: break-word;
        border: 1px solid rgba(255, 255, 255, 0.4);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }

      .input_cont textarea:focus {
        outline: none;
        border-color: rgba(5, 130, 171, 0.7);
        box-shadow: 0 0 0 4px rgba(5, 130, 171, 0.2);
        background: rgba(255, 255, 255, 0.85);
      }

      .input_btn_box {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
      }

      .input_btn_box button {
        width: 35px;
        height: 35px;
        border: none;
        padding: 0;
        border-radius: 50%;
        color: rgb(191, 76, 51);
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: clamp(18px, 1.5vw, 20px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      }

      .input_btn_box button:hover {
        transform: translateY(-3px);
        color: rgb(171, 30, 5);
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.12);
      }

      .file-input-container {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        width: clamp(40px, 4vw, 45px);
        height: clamp(40px, 4vw, 45px);
      }

      .file-input-container input[type="file"] {
        position: absolute;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
        z-index: 2;
      }

      .file-input-container .file-label {
        width: clamp(40px, 4vw, 45px);
        height: clamp(40px, 4vw, 45px);
        border: none;
        border-radius: 50%;
        color: rgb(11, 54, 58);
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: clamp(18px, 1.5vw, 20px);
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.4);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      }

      .file-input-container .file-label:hover {
        transform: translateY(-3px);
        color: rgba(5, 130, 171, 1);
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.12);
      }

      .send-btn-container {
        right: clamp(15px, 2vw, 20px);
      }

      .send-btn-container button {
        width: 30px;
        height:30px;
        border: none;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        background: linear-gradient(
          135deg,
          rgba(5, 130, 171, 0.95),
          rgba(23, 162, 184, 0.95)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: clamp(18px, 1.5vw, 20px);
        box-shadow: 0 6px 20px rgba(5, 130, 171, 0.3);
        border: 2px solid white;
      }

      .send-btn-container button:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 8px 25px rgba(5, 130, 171, 0.4);
        background: linear-gradient(
          135deg,
          rgba(5, 130, 171, 1),
          rgba(23, 162, 184, 1)
        );
      }

      .send-btn-container button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        background: linear-gradient(
          135deg,
          rgba(108, 117, 125, 0.7),
          rgba(73, 80, 87, 0.7)
        );
        box-shadow: 0 4px 10px rgba(108, 117, 125, 0.2);
      }

      /* Animatsiyalar */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Responsive dizayn - YAXSHILANGAN */
      @media (max-width: 1400px) {
        .body_chat,
        .footer_chat,
        .head_box {
          width: 70%;
        }
        .head_box {
          right: 15%;
        }
        .sidebar-line {
          left: 10%;
        }
        .scroll-to-bottom {
          right: 15%;
        }
      }

      @media (max-width: 1200px) {
        .body_chat,
        .footer_chat,
        .head_box {
          width: 60%;
        }
        .head_box {
          right: 10%;
        }
        .sidebar-line {
          display: none;
        }
        .scroll-to-bottom {
          right: 10%;
        }
      }

      @media (max-width: 992px) {
        .body_chat,
        .footer_chat,
        .head_box {
          width: 90%;
        }
        .head_box {
          right: 5%;
        }

        .logo h1 {
          font-size: 1.6rem;
        }

        .scroll-to-bottom {
          right: 5%;
        }

        .body_chat {
          padding-top: 100px;
        }
      }

      @media (max-width: 768px) {
        .body_chat,
        .footer_chat,
        .head_box {
          width: 95%;
        }
        .head_box {
          right: 2.5%;
        }

        .logo h1 {
          font-size: 1.4rem;
        }

        .logo .fa-robot {
          font-size: 1.6rem;
        }

        .btn_box button {
          padding: 8px 12px;
          font-size: 0.85rem;
        }

        .story_list {
          width: 90%;
          right: 5%;
          max-height: 60vh;
        }

        .send-btn-container {
          right: 15px;
          top: -65px;
        }

        .scroll-to-bottom {
          right: 2.5%;
          bottom: 85px;
        }

        .body_chat {
          padding-top: 90px;
          margin-top: 0;
        }

        .infochat {
          padding: 15px;
        }

        .body_chat h3 {
          font-size: 1.5rem;
        }

        .body_chat p {
          font-size: 0.95rem;
        }

        .message-container {
          max-height: calc(100vh - 280px);
        }
      }

      @media (max-width: 576px) {
        .body_chat,
        .footer_chat,
        .head_box {
          width: 98%;
        }
        .head_box {
          right: 1%;
          top: 5px;
        }

        .body_chat {
          padding-top: 80px;
        }

        .body_chat h3 {
          font-size: 1.3rem;
        }

        .body_chat p {
          font-size: 0.9rem;
        }

        .logo {
          gap: 6px;
        }

        .logo h1 {
          font-size: 1.2rem;
        }

        .logo .fa-robot {
          font-size: 1.4rem;
        }

        .btn_box {
          gap: 5px;
        }

        .btn_box button {
          width: auto;
          padding: 6px 10px;
          font-size: 0.75rem;
          gap: 4px;
        }

        .footer_chat {
          bottom: 12px;
          padding: 10px 0;
        }

        .send-btn-container {
          right: 10px;
          top: -55px;
        }

        .send-btn-container button {
          width: 42px;
          height: 42px;
          font-size: 16px;
        }

        .scroll-to-bottom {
          right: 1%;
          bottom: 80px;
          width: 34px;
          height: 34px;
        }

        .message {
          max-width: 90%;
          padding: 12px 14px;
          font-size: 0.95rem;
        }

        .copy-btn {
          width: 26px;
          height: 26px;
          font-size: 11px;
        }

        .input_cont textarea {
          padding: 12px 55px 12px 12px;
          font-size: 0.9rem;
          min-height: 50px;
        }

        .input_btn_box button,
        .file-input-container,
        .file-input-container .file-label {
          width: 38px;
          height: 38px;
          font-size: 16px;
        }

        .story_list {
          width: 95%;
          right: 2.5%;
          padding: 15px;
        }

        .story_list h3 {
          font-size: 1.1rem;
        }
      }

      @media (max-width: 400px) {
        .logo h1 {
          font-size: 1rem;
        }

        .logo .fa-robot {
          font-size: 1.2rem;
        }

        .btn_box button {
          padding: 5px 8px;
          font-size: 0.7rem;
        }

        .body_chat h3 {
          font-size: 1.1rem;
        }

        .body_chat p {
          font-size: 0.85rem;
        }

        .footer_chat {
          padding: 8px 0;
        }

        .input_cont textarea {
          min-height: 45px;
          font-size: 0.85rem;
        }
      }
    </style>
<main class="ai-chat-wrapper">

    <section class="ai_chat_container">
        {% csrf_token %}
      <div class="conatner_ai_head">
        <div class="header_chat">
          <div class="head_box">
            <div class="logo">
              <i class="fas fa-robot"></i>
              <h1>AI Chat</h1>
            </div>
            <div class="btn_box">
              <button id="newChatBtn">
                <i class="fas fa-plus"></i> New chat
              </button>
              <button id="historyBtn">
                <i class="fas fa-history"></i> Tarix
              </button>
              <nav class="story_list" id="storyList">
                <h3><i class="fas fa-history"></i> Chat tarixi</h3>
                <ul id="historyList">
                  <!-- Tarix elementlari dinamik ravishda qo'shiladi -->
                </ul>
                <button class="clear_history" id="clearHistoryBtn">
                  <i class="fas fa-trash"></i> Barcha tarixni o'chirish
                </button>
              </nav>
            </div>
          </div>
        </div>
      </div>

      <div class="body_chat">
        <div class="infochat" id="infoAi">
          <h3><i class="fas fa-robot"></i> Salom! Men AI yordamchisiman</h3>
          <p>
            Sizning mutaxasisligingiz bo'yicha talabalarga yana qanday
            bilimlarni berishni istaysiz? Menga tushunarli tarzda savolingizni
            kiriting! Men sizga qiziqarli materiallarni taqdim etaman.
          </p>
        </div>

        <!-- Chat xabarlar konteyneri -->
        <div class="message-container" id="messageContainer">
          <!-- Chat xabarlar shu yerda paydo bo'ladi -->
        </div>

        <!-- Kutish effekti -->
        <div class="typing-indicator" id="typingIndicator">
          <span></span>
          <span></span>
          <span></span>
        </div>

        <!-- Scroll to bottom button -->
        <button class="scroll-to-bottom" id="scrollToBottomBtn">
          <i class="fas fa-chevron-down"></i>
        </button>
      </div>

      <div class="footer_chat">
        <div class="input_cont">

          <textarea
            id="messageInput"
            placeholder="Xabaringizni yozing..."
            rows="1"
          ></textarea>
          <div class="input_btn_box">
            <div style="display: flex; gap: 10px; align-items: center;">
                <button id="clearBtn"><i class="fas fa-trash"></i></button>
            <div class="file-input-container">
              <input type="file" id="fileInput" />
              <div class="file-label">
                <i class="fas fa-plus"></i>
              </div>

            </div>
            </div>
            <div class="send-btn-container">
            <button id="sendBtn" disabled>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                fill="currentColor"
                class="bi bi-arrow-up"
                viewBox="0 0 16 16"
              >
                <path
                  fill-rule="evenodd"
                  d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5"
                />
              </svg>
            </button>
          </div>
          </div>
        </div>
      </div>
    </section>
</main>
{% endblock %}

{% block scripts %}
 <script>
      // DOM elementlari
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const clearBtn = document.getElementById("clearBtn");
      const messageContainer = document.getElementById("messageContainer");
      const typingIndicator = document.getElementById("typingIndicator");
      const historyBtn = document.getElementById("historyBtn");
      const storyList = document.getElementById("storyList");
      const historyList = document.getElementById("historyList");
      const clearHistoryBtn = document.getElementById("clearHistoryBtn");
      const newChatBtn = document.getElementById("newChatBtn");
      const fileInput = document.getElementById("fileInput");
      const infoAi = document.getElementById("infoAi");
      const scrollToBottomBtn = document.getElementById("scrollToBottomBtn");

      // Chat tarixi
      let chatHistory = JSON.parse(localStorage.getItem("aiChatHistory")) || [];
      let currentChat = [];
      let isTypingEffectActive = false;
      let selectedFile = null;
      let typingSpeed = 8; // Tezlik (ms) - qancha kichik, shuncha tez

      // CSRF token olish
      function getCSRFToken() {
          return document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
      }


      // Tarixni yuklash - YAXSHILANGAN
      function loadHistory() {
        historyList.innerHTML = "";

        if (chatHistory.length === 0) {
          const emptyMessage = document.createElement("li");
          emptyMessage.innerHTML = `
            <div style="text-align: center; color: #6c757d; padding: 20px;">
              <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
              <p>Hozircha chat tarixi mavjud emas</p>
            </div>
          `;
          historyList.appendChild(emptyMessage);
          return;
        }

        chatHistory.forEach((chat, index) => {
          if (chat && chat.length > 0) {
            const firstMessage = chat[0].text;
            const previewText =
              firstMessage.length > 40
                ? firstMessage.substring(0, 40) + "..."
                : firstMessage;
            const date = chat[0].timestamp
              ? new Date(chat[0].timestamp).toLocaleDateString("uz-UZ", {
                  month: "short",
                  day: "numeric",
                })
              : "Hozir";

            const li = document.createElement("li");
            li.innerHTML = `
              <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                  <small style="color: #6c757d; font-size: 0.8rem;">${date}</small>
                  <button class="delete-chat" data-index="${index}">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <span class="chat-preview">${previewText}</span>
              </div>
            `;

            li.onclick = (e) => {
              if (!e.target.closest(".delete-chat")) {
                loadChat(index);
              }
            };
            historyList.appendChild(li);
          }
        });
      }

      // Chatni yuklash
      function loadChat(index) {
        if (chatHistory[index]) {
          currentChat = chatHistory[index];
          messageContainer.innerHTML = "";
          infoAi.style.display = "none";
          currentChat.forEach((message) => {
            addMessage(message.text, message.type, false);
          });
          storyList.classList.remove("show");
          scrollToLatestMessage();
          updateScrollButton();
        }
      }

      // Yangi chat boshlash
      function startNewChat() {
        if (currentChat.length > 0) {
          chatHistory.push([...currentChat]);
          localStorage.setItem("aiChatHistory", JSON.stringify(chatHistory));
        }
        currentChat = [];
        messageContainer.innerHTML = "";
        infoAi.style.display = "block";
        messageInput.value = "";
        selectedFile = null;
        updateSendButton();
        adjustTextareaHeight();
        updateScrollButton();
        loadHistory();
      }

      // Harfma-harf chiqish effekti
      function typeWriter(text, element) {
        isTypingEffectActive = true;
        element.innerHTML = '<span class="typing-text"></span>';
        const typingElement = element.querySelector(".typing-text");

        let index = 0;
        const words = text.split(" ");

        function typeNextWord() {
          if (index < words.length) {
            const wordSpan = document.createElement("span");
            wordSpan.textContent = words[index] + " ";
            wordSpan.style.animationDelay = `${index * 0.005}s`;
            typingElement.appendChild(wordSpan);
            index++;

            setTimeout(typeNextWord, typingSpeed);
            scrollToLatestMessage();
          } else {
            isTypingEffectActive = false;
          }
        }
        typeNextWord();
      }

      // Xabar qo'shish
      function addMessage(text, type, animate = true) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}-message`;

        const messageContent = document.createElement("div");
        messageContent.style.position = "relative";
        messageContent.style.paddingRight = "40px";

        const iconDiv = document.createElement("div");
        iconDiv.style.display = "flex";
        iconDiv.style.alignItems = "flex-start";
        iconDiv.style.gap = "12px";

        const icon = document.createElement("i");
        icon.className = `fas ${type === "user" ? "fa-user" : "fa-robot"}`;
        icon.style.color =
          type === "user"
            ? "rgba(5, 130, 171, 0.9)"
            : "rgba(23, 162, 184, 0.9)";
        icon.style.marginTop = "4px";
        icon.style.fontSize = "1.1rem";

        const contentDiv = document.createElement("div");
        contentDiv.style.flex = "1";
        contentDiv.style.fontSize = "1.05rem";

        // Copy button qo'shish
        const copyBtn = document.createElement("button");
        copyBtn.className = "copy-btn";
        copyBtn.innerHTML = '<i class="far fa-copy"></i>';
        copyBtn.title = "Nusxa olish";
        copyBtn.onclick = (e) => {
          e.stopPropagation();
          copyToClipboard(text);
          showCopyNotification();
        };

        iconDiv.appendChild(icon);
        iconDiv.appendChild(contentDiv);
        messageContent.appendChild(iconDiv);
        messageContent.appendChild(copyBtn);
        messageDiv.appendChild(messageContent);

        if (type === "ai" && animate && !isTypingEffectActive) {
          setTimeout(() => {
            typeWriter(text, contentDiv);
          }, 100);
        } else {
          contentDiv.textContent = text;
        }

        messageContainer.appendChild(messageDiv);
        scrollToLatestMessage();
        updateScrollButton();

        // Chatni saqlash
        currentChat.push({
          text,
          type,
          timestamp: new Date().toISOString(),
        });
      }

      // Nusxa olish funksiyasi
      function copyToClipboard(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            console.log("Matn nusxalandi");
          })
          .catch((err) => {
            console.error("Nusxalashda xato:", err);
          });
      }

      // Nusxa olish bildirishnomasi
      function showCopyNotification() {
        const notification = document.createElement("div");
        notification.textContent = "âœ… Nusxa olindi!";
        notification.style.cssText = `
          position: fixed;
          top: 120px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(5, 130, 171, 0.95);
          color: white;
          padding: 12px 24px;
          border-radius: 25px;
          z-index: 10000;
          animation: fadeInOut 2s ease;
          font-weight: 500;
          box-shadow: 0 6px 20px rgba(5, 130, 171, 0.3);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.3);
        `;

        const style = document.createElement("style");
        style.textContent = `
          @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(-15px); }
            20% { opacity: 1; transform: translateX(-50%) translateY(0); }
            80% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-15px); }
          }
        `;

        document.head.appendChild(style);
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
          style.remove();
        }, 2000);
      }

      // Eng oxirgi xabarga scroll qilish
      function scrollToLatestMessage() {
        messageContainer.scrollTop = messageContainer.scrollHeight;
        updateScrollButton();
      }

      // Scroll tugmasini yangilash
      function updateScrollButton() {
        const isAtBottom =
          messageContainer.scrollHeight -
            messageContainer.scrollTop -
            messageContainer.clientHeight <
          50;
        if (isAtBottom) {
          scrollToBottomBtn.classList.remove("visible");
        } else {
          scrollToBottomBtn.classList.add("visible");
        }
      }

      // Kutish effekti
      function showTypingIndicator() {
        typingIndicator.style.display = "flex";
        typingIndicator.style.alignItems = "center";
        typingIndicator.style.gap = "10px";
        typingIndicator.innerHTML = `
          <i class="fas fa-robot" style="color: rgba(23, 162, 184, 0.9); font-size: 1.2rem;"></i>
          <div style="display: flex; gap: 5px;">
            <span></span>
            <span></span>
            <span></span>
          </div>
        `;
        messageContainer.appendChild(typingIndicator);
        scrollToLatestMessage();
      }

      function hideTypingIndicator() {
        if (typingIndicator.parentNode === messageContainer) {
          messageContainer.removeChild(typingIndicator);
        }
      }

      // Yuborish tugmasini yangilash
      function updateSendButton() {
        const hasText = messageInput.value.trim().length > 0;
        const hasFile = selectedFile !== null;
        sendBtn.disabled = !(hasText || hasFile);
      }

      // AI javobini API orqali olish
      // AI javobini API orqali olish
async function getAIResponse(userMessage) {
    console.log("ðŸ”„ API ga so'rov yuborilmoqda...");

    // URL ni localization bilan moslashtirish
    const currentPath = window.location.pathname;
    let apiUrl;

    // Agar /uz/ prefiksi bo'lsa
    if (currentPath.includes('/uz/')) {
        apiUrl = '/uz/ai-chat/';
    } else {
        apiUrl = '/ai-chat/';
    }

    console.log("ðŸŒ API URL:", apiUrl);
    console.log("ðŸ“ Xabar:", userMessage);

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                message: userMessage
            })
        });

        console.log("ðŸ“¡ API Status:", response.status);
        console.log("ðŸ“¡ API Redirect:", response.redirected);

        // Agar redirect bo'lsa
        if (response.redirected) {
            console.warn("âš ï¸ Redirect edildi:", response.url);
            throw new Error('Authentication kerak yoki CSRF xatosi');
        }

        if (!response.ok) {
            throw new Error(`Server xatosi: ${response.status}`);
        }

        const data = await response.json();
        console.log("âœ… API javobi:", data);

        if (data.success) {
            return data.response;
        } else {
            throw new Error(data.response || 'Server xatosi');
        }

    } catch (error) {
        console.error('âŒ Fetch xatosi:', error);
        throw error;
    }
}
      // Textarea balandligini sozlash
      function adjustTextareaHeight() {
        const textarea = messageInput;
        textarea.style.height = "auto";

        const minHeight = 60;
        const maxHeight = window.innerHeight * 0.35;

        const scrollHeight = textarea.scrollHeight;
        let newHeight = Math.max(minHeight, scrollHeight);
        newHeight = Math.min(newHeight, maxHeight);

        textarea.style.height = newHeight + "px";

        const footer = document.querySelector(".footer_chat");
        const baseHeight = 140;
        const extraHeight = Math.max(0, newHeight - minHeight);
        footer.style.height = baseHeight + extraHeight + "px";

        const sendBtnContainer = document.querySelector(".send-btn-container");
        sendBtnContainer.style.top = `-${newHeight + 15}px`;
      }

      // Fayl yuklashni simulyatsiya qilish
      function simulateFileUpload() {
        showTypingIndicator();

        setTimeout(() => {
          hideTypingIndicator();
          addMessage(
            "Faylingizni qabul qildim! Fayl haqida ma'lumot bering yoki undan foydalanish uchun nima qilishimni aytib bering.",
            "ai"
          );
        }, 500);
      }

      // Xabar yuborish
      async function sendMessage() {
        const message = messageInput.value.trim();

        if (selectedFile && !message) {
          if (infoAi.style.display !== "none") {
            infoAi.style.display = "none";
          }

          addMessage(`ðŸ“Ž Fayl yuklandi: ${selectedFile.name}`, "user");
          messageInput.value = "";
          selectedFile = null;
          updateSendButton();
          adjustTextareaHeight();

          simulateFileUpload();
          return;
        }

        if (!message) return;

        if (infoAi.style.display !== "none") {
          infoAi.style.display = "none";
        }

        addMessage(message, "user");
        messageInput.value = "";
        selectedFile = null;
        updateSendButton();
        adjustTextareaHeight();

        try {
          // API orqali javob olish
          const aiResponse = await getAIResponse(message);
          addMessage(aiResponse, "ai");

        } catch (error) {
          console.error('AI javob olishda xatolik:', error);

          // Agar API ishlamasa, offline javob berish
          const responses = {
            "Python nima?":
              "Python - bu yuqori darajali, interpretatsiya qilinadigan dasturlash tili bo'lib, oddiy sintaksis va kuchli kutubxonalarga ega.",
            "Django qanday ishlaydi?":
              "Django - bu Python dasturlash tilida yozilgan yuqori darajali web framework.",
            "default":
              "Kechirasiz, server bilan aloqa xatosi. Keyinroq urinib ko'ring. Qiziqarli savol! Python - bu dasturlashning keng qo'llaniladigan tili bo'lib, u soddaligi va kuchli imkoniyatlari bilan ajralib turadi."
          };

          const response = responses[message] || responses["default"];
          addMessage(response, "ai");
        }
      }

      // Event listenerlar
      sendBtn.addEventListener("click", sendMessage);

      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          if (!sendBtn.disabled) {
            sendMessage();
          }
        }
      });

      messageInput.addEventListener("input", () => {
        adjustTextareaHeight();
        updateSendButton();
      });

      clearBtn.addEventListener("click", () => {
        messageContainer.innerHTML = "";
        currentChat = [];
        messageInput.value = "";
        selectedFile = null;
        infoAi.style.display = "block";
        updateSendButton();
        adjustTextareaHeight();
        updateScrollButton();
      });

      historyBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        storyList.classList.toggle("show");
        if (storyList.classList.contains("show")) {
          loadHistory();
        }
      });

      clearHistoryBtn.addEventListener("click", () => {
        if (confirm("Barcha chat tarixini o'chirishni istaysizmi?")) {
          chatHistory = [];
          localStorage.removeItem("aiChatHistory");
          loadHistory();
          storyList.classList.remove("show");
        }
      });

      newChatBtn.addEventListener("click", startNewChat);

      // Fayl yuklash
      fileInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) {
          selectedFile = e.target.files[0];
          updateSendButton();

          messageInput.value = `ðŸ“Ž ${selectedFile.name}`;
          adjustTextareaHeight();
        }
      });

      // Scroll to bottom button
      scrollToBottomBtn.addEventListener("click", scrollToLatestMessage);

      // Scrollni kuzatish
      messageContainer.addEventListener("scroll", updateScrollButton);

      // Sahifa yuklanganda
      document.addEventListener("DOMContentLoaded", () => {
        loadHistory();
        adjustTextareaHeight();
        updateSendButton();
        updateScrollButton();

        window.addEventListener("resize", adjustTextareaHeight);
      });

      // Tarix elementlarini o'chirish
      document.addEventListener("click", (e) => {
        if (e.target.closest(".delete-chat")) {
          e.stopPropagation();
          const index = parseInt(
            e.target.closest(".delete-chat").getAttribute("data-index")
          );
          if (confirm("Bu chatni o'chirishni istaysizmi?")) {
            chatHistory.splice(index, 1);
            localStorage.setItem("aiChatHistory", JSON.stringify(chatHistory));
            loadHistory();
          }
        }
      });

      // Tarix panelidan tashqariga bosilganda yopish
      document.addEventListener("click", (e) => {
        if (
          !e.target.closest("#storyList") &&
          !e.target.closest("#historyBtn")
        ) {
          storyList.classList.remove("show");
        }
      });
    </script>
{% endblock %}