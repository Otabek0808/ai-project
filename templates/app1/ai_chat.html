{% extends 'base.html' %} {% block content %}
<style>
  #container_ai {
    width: 100%;
  }

  /* AI Chat uchun maxsus stillar */

  .ai-chat-card {
    min-height: calc(100vh - 100px);
    backdrop-filter: blur(10px);
    background-color: rgba(255, 255, 255, 0.511);
    border-radius: 15px;
    border: 2px solid #ffffff;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  .ai-chat-header {
    backdrop-filter: blur(10px);
    background-color: rgba(5, 130, 171, 0.8) !important;
    border-radius: 15px 15px 0 0 !important;
    border-bottom: 2px solid #ffffff;
    padding: 15px 20px !important;
  }

  .ai-chat-header h4 {
    font-size: 24px;
    font-weight: bold;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .ai-chat-header .fa-robot {
    font-size: 28px;
  }

  .ai-chat-body {
    padding: 25px !important;
    width: 70%;
    margin: 0 auto;
  }

  .chat-messages-container {
    height: 400px;
    overflow-y: auto;
    backdrop-filter: blur(10px);
    background-color: rgba(255, 255, 255, 0.7);
    border: 2px solid #ffffff;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 10px;
  }

  .chat-message {
    margin-bottom: 15px;
    max-width: 100%;
    display: flex;
  }

  .user-message {
    justify-content: flex-end;
  }

  .bot-message {
    justify-content: flex-start;
  }

  .message-bubble {
    display: inline-block;
    padding: 12px 18px;
    border-radius: 15px;
    font-size: 15px;
    line-height: 1.5;
    max-width: 100%;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    word-wrap: break-word;
    overflow-wrap: break-word;
    word-break: break-word;
    hyphens: auto;
  }

  /* Uzoq so'zlar uchun qo'shimcha */
  .message-bubble {
    -webkit-hyphens: auto;
    -ms-hyphens: auto;
    hyphens: auto;
    white-space: pre-wrap; /* Pre format saqlash */
    white-space: -moz-pre-wrap; /* Firefox */
    white-space: -pre-wrap; /* Opera */
    white-space: -o-pre-wrap; /* Opera */
    word-wrap: break-word; /* IE */
  }

  .user-bubble {
    background: linear-gradient(135deg, #87ceeb, #5aa9e6);
    color: white;
    border: 1px solid #5aa9e6;
    border-radius: 15px 15px 0 15px;
    max-width: 70%; /* Foydalanuvchi xabari kengligini cheklash */
  }

  .bot-bubble {
    background: rgba(255, 255, 255, 0.9);
    color: #333;
    border: 1px solid #ffffff;
    border-radius: 15px 15px 15px 0;
    max-width: 85%; /* Bot xabari kengligini cheklash */
  }

  .chat-input-group {
    display: flex;
    gap: 10px;
  }

  .chat-input-group input {
    flex: 1;
    padding: 12px 15px;
    border: 2px solid #ffffff;
    border-radius: 10px;
    backdrop-filter: blur(10px);
    background-color: rgba(255, 255, 255, 0.8);
    font-size: 15px;
    transition: all 0.3s ease;
  }

  .chat-input-group input:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(5, 130, 171, 0.3);
    border-color: rgba(5, 130, 171, 0.8);
  }

  .chat-submit-btn {
    padding: 12px 25px;
    border: none;
    border-radius: 10px;
    backdrop-filter: blur(100px);
    background-color: rgba(5, 130, 171, 0.8);
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .chat-submit-btn:hover {
    transform: scale(0.97);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    background-color: rgba(5, 130, 171, 1);
  }

  .chat-tips {
    margin-top: 15px;
    padding: 12px;
    backdrop-filter: blur(10px);
    background-color: rgba(255, 255, 255, 0.7);
    border-radius: 10px;
    border: 1px solid #ffffff;
    font-size: 14px;
  }

  .chat-tips .fa-lightbulb {
    color: #ffc107;
    margin-right: 8px;
  }

  /* Scrollbar styling */
  .chat-messages-container::-webkit-scrollbar {
    width: 8px;
  }

  .chat-messages-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
  }

  .chat-messages-container::-webkit-scrollbar-thumb {
    background: rgba(5, 130, 171, 0.5);
    border-radius: 4px;
  }

  .chat-messages-container::-webkit-scrollbar-thumb:hover {
    background: rgba(5, 130, 171, 0.8);
  }

  /* Welcome message */
  .welcome-message {
    text-align: center;
    padding: 15px;
    backdrop-filter: blur(10px);
    background-color: rgba(5, 130, 171, 0.1);
    border-radius: 10px;
    border: 1px solid rgba(5, 130, 171, 0.3);
    margin-bottom: 15px;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  /* Code formatting for bot messages */
  .bot-bubble pre {
    background: rgba(0, 0, 0, 0.05);
    padding: 10px;
    border-radius: 5px;
    overflow-x: auto;
    margin: 10px 0;
    font-family: "Courier New", monospace;
    font-size: 14px;
    white-space: pre-wrap;
  }

  .bot-bubble code {
    background: rgba(0, 0, 0, 0.05);
    padding: 2px 5px;
    border-radius: 3px;
    font-family: "Courier New", monospace;
    font-size: 14px;
  }

  /* MEDIA QUERIES */

  /* 1001px - Tablet view */
  @media (max-width: 1001px) {
    .ai-chat-container {
      padding: 15px;
      border-radius: 15px;
    }

    .ai-chat-body {
      padding: 20px !important;
    }

    .chat-messages-container {
      height: 350px;
      padding: 15px;
    }

    .ai-chat-header h4 {
      font-size: 20px;
    }

    .user-bubble {
      max-width: 75%; /* Kichik ekranlarda kengroq */
    }

    .bot-bubble {
      max-width: 90%; /* Kichik ekranlarda kengroq */
    }
  }

  /* 830px */
  @media (max-width: 830px) {
    .ai-chat-container {
      padding: 10px;
    }

    .chat-messages-container {
      height: 320px;
    }

    .message-bubble {
      padding: 10px 15px;
      font-size: 14px;
    }

    .user-bubble {
      max-width: 80%;
    }

    .bot-bubble {
      max-width: 95%;
    }
  }

  /* 710px */
  @media (max-width: 710px) {
    .ai-chat-container {
      padding: 8px;
      border-radius: 10px;
    }

    .ai-chat-body {
      padding: 15px !important;
    }

    .chat-messages-container {
      height: 300px;
      padding: 12px;
    }

    .ai-chat-header {
      padding: 12px 15px !important;
    }

    .ai-chat-header h4 {
      font-size: 18px;
    }

    .chat-input-group input {
      padding: 10px 12px;
      font-size: 14px;
    }

    .chat-submit-btn {
      padding: 10px 20px;
      font-size: 14px;
    }

    .message-bubble {
      padding: 8px 12px;
      font-size: 13px;
    }
  }

  /* 620px */
  @media (max-width: 620px) {
    .ai-chat-container {
      padding: 5px;
    }

    .chat-messages-container {
      height: 280px;
      padding: 10px;
    }

    .message-bubble {
      padding: 8px 12px;
      font-size: 13px;
    }

    .user-bubble {
      max-width: 85%;
    }

    .bot-bubble {
      max-width: 95%;
    }

    .chat-input-group {
      flex-direction: column;
    }

    .chat-submit-btn {
      width: 100%;
      justify-content: center;
    }
  }

  /* 480px - Mobile */
  @media (max-width: 480px) {
    .ai-chat-container {
      border-radius: 8px;
    }

    .ai-chat-body {
      padding: 12px !important;
    }

    .chat-messages-container {
      height: 250px;
    }

    .ai-chat-header h4 {
      font-size: 16px;
    }

    .chat-input-group input {
      padding: 8px 10px;
      font-size: 13px;
    }

    .chat-submit-btn {
      padding: 8px 15px;
      font-size: 13px;
    }

    .chat-tips {
      font-size: 12px;
      padding: 10px;
    }

    .message-bubble {
      padding: 6px 10px;
      font-size: 12px;
    }

    .user-bubble {
      max-width: 90%;
    }

    .bot-bubble {
      max-width: 95%;
    }
  }

  /* Kichik ekranlar uchun qo'shimcha */
  @media (max-width: 360px) {
    .message-bubble {
      font-size: 11px;
      padding: 5px 8px;
    }

    .user-bubble,
    .bot-bubble {
      max-width: 95%;
    }
  }
</style>

<div class="ai-chat-container mt-3" id="container_ai">
  <div class="row justify-content-center">
    <div class="col-12">
      <div class="ai-chat-card">
        <div class="ai-chat-header card-header text-white">
          <h4 class="mb-0"><i class="fas fa-robot"></i> AI Chat Bot</h4>
        </div>
        <div class="ai-chat-body card-body">
          <div class="chat-messages-container" id="chat-container">
            <div class="welcome-message">
              <i class="fas fa-info-circle"></i> Savolingizni bering, men sizga
              yordam berishga harakat qilaman!
            </div>
          </div>

          <form id="chat-form">
            {% csrf_token %}
            <div class="chat-input-group">
              <input
                type="text"
                id="user-input"
                class="form-control"
                placeholder="Savolingizni yozing..."
                required
                autocomplete="off"
              />
              <button type="submit" class="chat-submit-btn">
                <i class="fas fa-paper-plane"></i> Yuborish
              </button>
            </div>
          </form>

          <div class="chat-tips">
            <small>
              <i class="fas fa-lightbulb"></i> Maslahat: Dasturlash, Python,
              Django, HTML, CSS, JavaScript haqida savol bering.
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document.getElementById("chat-form").addEventListener("submit", function (e) {
    e.preventDefault();

    const userInput = document.getElementById("user-input");
    const message = userInput.value.trim();

    if (!message) return;

    // Foydalanuvchi xabarini ko'rsatish
    addMessage(message, "user");
    userInput.value = "";

    // Inputni vaqtincha disabled qilish
    userInput.disabled = true;
    document.querySelector(".chat-submit-btn").disabled = true;
    document.querySelector(".chat-submit-btn").innerHTML =
      '<i class="fas fa-spinner fa-spin"></i> Kutish...';

    // AI javobini so'rash
    fetch("/ai-chat/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
          .value,
      },
      body: JSON.stringify({ message: message }),
    })
      .then((response) => response.json())
      .then((data) => {
        // Matnni formatlash (agar kod bo'lsa)
        const formattedResponse = formatMessage(data.response);
        addMessage(formattedResponse, "bot");
      })
      .catch((error) => {
        console.error("Error:", error);
        addMessage("Xatolik yuz berdi. Iltimos, qayta urinib ko'ring.", "bot");
      })
      .finally(() => {
        // Inputni qayta aktivlashtirish
        userInput.disabled = false;
        document.querySelector(".chat-submit-btn").disabled = false;
        document.querySelector(".chat-submit-btn").innerHTML =
          '<i class="fas fa-paper-plane"></i> Yuborish';
        userInput.focus();
      });
  });

  function addMessage(text, sender) {
    const chatContainer = document.getElementById("chat-container");
    const messageDiv = document.createElement("div");
    messageDiv.className = `chat-message ${
      sender === "user" ? "user-message" : "bot-message"
    }`;

    const bubble = document.createElement("div");
    bubble.className = `message-bubble ${
      sender === "user" ? "user-bubble" : "bot-bubble"
    }`;

    // Agar bot javobi bo'lsa va formatlash kerak bo'lsa
    if (sender === "bot") {
      bubble.innerHTML = formatMessage(text);
    } else {
      bubble.textContent = text;
    }

    messageDiv.appendChild(bubble);
    chatContainer.appendChild(messageDiv);

    // Scrollni pastga olib borish
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  // Matnni formatlash funksiyasi (kod uchun)
  function formatMessage(text) {
    // Oddiy text return qilish
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;")
      .replace(/\n/g, "<br>")
      .replace(/```([\s\S]*?)```/g, "<pre><code>$1</code></pre>")
      .replace(/`([^`]+)`/g, "<code>$1</code>");
  }

  // Enter tugmasi bilan yuborish
  document
    .getElementById("user-input")
    .addEventListener("keypress", function (e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        document.getElementById("chat-form").dispatchEvent(new Event("submit"));
      }
    });

  // Shift+Enter bilan yangi qator
  document
    .getElementById("user-input")
    .addEventListener("keydown", function (e) {
      if (e.key === "Enter" && e.shiftKey) {
        // Yangi qator qo'shish
        return true;
      }
    });

  // Sahifa yuklanganda inputga fokus qilish
  document.addEventListener("DOMContentLoaded", function () {
    const userInput = document.getElementById("user-input");
    if (userInput) {
      setTimeout(() => {
        userInput.focus();
      }, 300);
    }
  });

  // Chat container o'lchami o'zgarganda scrollni pastga olib borish
  const chatContainer = document.getElementById("chat-container");
  if (chatContainer) {
    const observer = new MutationObserver(function () {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    });

    observer.observe(chatContainer, { childList: true, subtree: true });
  }
</script>
{% endblock %}
