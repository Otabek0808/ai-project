{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
{% endblock %}

{% block content %}
<style>
  :root {
    --primary-color: #6366f1;
    --primary-dark: #4f46e5;
    --secondary-color: #8b5cf6;
    --accent-color: #06b6d4;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
    --light-bg: rgba(255, 255, 255, 0.9);
    --dark-bg: rgba(15, 23, 42, 0.9);
    --card-bg: rgba(255, 255, 255, 0.95);
    --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  /* Animatsiyalar */
  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  @keyframes slideIn {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  @keyframes typing {
    0% { width: 0; }
    50% { width: 100%; }
    100% { width: 0; }
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
  }

  /* AI Chat container */
  .ai-chat-wrapper {
    min-height: 100vh;
    background: var(--gradient);
    padding: 20px;
    position: relative;
    overflow: hidden;
  }

  .ai-chat-wrapper::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    animation: float 20s infinite linear;
  }

  .ai-chat-container {
    max-width: 1200px;
    margin: 0 auto;
    height: 90vh;
    background: var(--card-bg);
    backdrop-filter: blur(20px);
    border-radius: 24px;
    box-shadow: var(--shadow);
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.2);
    position: relative;
    animation: fadeInUp 0.8s ease-out;
  }

  /* Header */
  .chat-header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    padding: 20px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    position: relative;
    overflow: hidden;
  }

  .chat-header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
      45deg,
      transparent 30%,
      rgba(255, 255, 255, 0.1) 50%,
      transparent 70%
    );
    animation: shimmer 3s infinite linear;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .ai-avatar {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    animation: float 3s ease-in-out infinite;
    box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
  }

  .header-info h1 {
    color: white;
    font-size: 24px;
    font-weight: 700;
    margin: 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .header-info p {
    color: rgba(255, 255, 255, 0.9);
    font-size: 14px;
    margin: 5px 0 0 0;
  }

  .header-actions {
    display: flex;
    gap: 10px;
  }

  .header-btn {
    padding: 8px 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border-radius: 50px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    backdrop-filter: blur(10px);
  }

  .header-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
  }

  .header-btn.danger {
    background: rgba(239, 68, 68, 0.2);
    border-color: rgba(239, 68, 68, 0.3);
  }

  .header-btn.danger:hover {
    background: rgba(239, 68, 68, 0.3);
  }

  /* Chat body */
  .chat-body {
    height: calc(100% - 140px);
    display: flex;
    flex-direction: column;
    padding: 20px;
    background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
  }

  .messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    margin-bottom: 20px;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 20px;
    border: 2px solid rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
  }

  /* Messages */
  .message {
    margin-bottom: 20px;
    display: flex;
    animation: slideIn 0.5s ease-out;
  }

  .message.user {
    justify-content: flex-end;
  }

  .message.bot {
    justify-content: flex-start;
  }

  .message-content {
    max-width: 70%;
    position: relative;
    padding: 16px 20px;
    border-radius: 20px;
    font-size: 15px;
    line-height: 1.6;
    word-wrap: break-word;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    animation: slideIn 0.3s ease-out;
  }

  .message.user .message-content {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border-bottom-right-radius: 5px;
    position: relative;
  }

  .message.user .message-content::after {
    content: '';
    position: absolute;
    right: -8px;
    top: 0;
    border-left: 10px solid var(--primary-color);
    border-top: 10px solid transparent;
    border-bottom: 10px solid transparent;
  }

  .message.bot .message-content {
    background: white;
    color: #334155;
    border-bottom-left-radius: 5px;
    border: 1px solid #e2e8f0;
    position: relative;
  }

  .message.bot .message-content::before {
    content: '';
    position: absolute;
    left: -8px;
    top: 0;
    border-right: 10px solid white;
    border-top: 10px solid transparent;
    border-bottom: 10px solid transparent;
  }

  .message-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }

  .message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
  }

  .message.user .message-avatar {
    background: linear-gradient(135deg, #8b5cf6, #06b6d4);
    color: white;
  }

  .message.bot .message-avatar {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
  }

  .message-sender {
    font-weight: 600;
    font-size: 14px;
  }

  .message-time {
    font-size: 12px;
    opacity: 0.7;
    margin-left: auto;
  }

  .message-text {
    margin: 10px 0;
  }

  /* Message types */
  .message-code {
    background: #1e293b;
    color: #e2e8f0;
    padding: 15px;
    border-radius: 10px;
    margin: 10px 0;
    overflow-x: auto;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.5;
  }

  .message-code .code-language {
    color: #94a3b8;
    font-size: 12px;
    margin-bottom: 10px;
    display: block;
  }

  .message-tips {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    border: 1px solid #f59e0b;
    border-radius: 10px;
    padding: 12px 16px;
    margin: 10px 0;
    font-size: 14px;
  }

  .message-warning {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    border: 1px solid #f59e0b;
    border-radius: 10px;
    padding: 12px 16px;
    margin: 10px 0;
    color: #92400e;
  }

  .message-success {
    background: linear-gradient(135deg, #d1fae5, #a7f3d0);
    border: 1px solid #10b981;
    border-radius: 10px;
    padding: 12px 16px;
    margin: 10px 0;
    color: #065f46;
  }

  /* Typing indicator */
  .typing-indicator {
    display: flex;
    gap: 6px;
    padding: 20px;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s;
  }

  .typing-indicator.active {
    opacity: 1;
  }

  .typing-dot {
    width: 8px;
    height: 8px;
    background: var(--primary-color);
    border-radius: 50%;
    animation: typing 1.5s infinite ease-in-out;
  }

  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }

  /* Input area */
  .input-container {
    background: white;
    border-radius: 20px;
    padding: 20px;
    border: 2px solid #e2e8f0;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
  }

  .input-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));
    animation: shimmer 2s infinite linear;
  }

  .chat-form {
    display: flex;
    gap: 15px;
    align-items: flex-end;
  }

  .input-wrapper {
    flex: 1;
    position: relative;
  }

  .chat-input {
    width: 100%;
    min-height: 60px;
    max-height: 200px;
    padding: 18px 60px 18px 25px;
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    font-size: 16px;
    line-height: 1.5;
    resize: none;
    outline: none;
    transition: all 0.3s ease;
    background: white;
    font-family: inherit;
  }

  .chat-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .input-icons {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    gap: 10px;
  }

  .input-icon {
    background: none;
    border: none;
    color: #94a3b8;
    font-size: 20px;
    cursor: pointer;
    transition: color 0.3s;
    padding: 5px;
  }

  .input-icon:hover {
    color: var(--primary-color);
  }

  .send-button {
    min-width: 120px;
    height: 60px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
    border-radius: 16px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 0 30px;
  }

  .send-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.4);
  }

  .send-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .send-button .spinner {
    display: none;
  }

  .send-button.loading .spinner {
    display: block;
    animation: spin 1s linear infinite;
  }

  .send-button.loading .text {
    display: none;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Quick actions */
  .quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
  }

  .quick-action-btn {
    padding: 10px 20px;
    background: rgba(99, 102, 241, 0.1);
    border: 2px solid rgba(99, 102, 241, 0.2);
    border-radius: 50px;
    color: var(--primary-color);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .quick-action-btn:hover {
    background: rgba(99, 102, 241, 0.2);
    transform: translateY(-2px);
  }

  /* Status indicator */
  .status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #64748b;
    margin-top: 10px;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--success-color);
    animation: pulse 2s infinite;
  }

  .status-dot.offline {
    background: var(--danger-color);
  }

  /* Welcome message */
  .welcome-message {
    text-align: center;
    padding: 40px 20px;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
    border-radius: 20px;
    border: 2px dashed rgba(99, 102, 241, 0.2);
    margin: 20px 0;
  }

  .welcome-icon {
    font-size: 60px;
    color: var(--primary-color);
    margin-bottom: 20px;
    animation: float 3s ease-in-out infinite;
  }

  .welcome-message h3 {
    color: var(--primary-dark);
    margin-bottom: 15px;
    font-size: 24px;
  }

  .welcome-message p {
    color: #64748b;
    font-size: 16px;
    line-height: 1.6;
    max-width: 600px;
    margin: 0 auto;
  }

  /* Scrollbar styling */
  .messages-container::-webkit-scrollbar {
    width: 8px;
  }

  .messages-container::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 4px;
  }

  .messages-container::-webkit-scrollbar-thumb {
    background: rgba(99, 102, 241, 0.3);
    border-radius: 4px;
  }

  .messages-container::-webkit-scrollbar-thumb:hover {
    background: rgba(99, 102, 241, 0.5);
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .ai-chat-wrapper {
      padding: 10px;
    }

    .chat-header {
      padding: 15px 20px;
      flex-direction: column;
      gap: 15px;
    }

    .header-left {
      flex-direction: column;
      text-align: center;
    }

    .header-actions {
      width: 100%;
      justify-content: center;
    }

    .message-content {
      max-width: 85%;
    }

    .chat-form {
      flex-direction: column;
    }

    .send-button {
      width: 100%;
    }

    .quick-actions {
      justify-content: center;
    }
  }

  @media (max-width: 480px) {
    .ai-chat-container {
      height: 95vh;
    }

    .message-content {
      max-width: 90%;
      padding: 12px 16px;
      font-size: 14px;
    }

    .input-container {
      padding: 15px;
    }

    .chat-input {
      min-height: 50px;
      padding: 12px 50px 12px 20px;
    }

    .send-button {
      height: 50px;
    }
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    .ai-chat-container {
      background: rgba(15, 23, 42, 0.95);
      color: #e2e8f0;
    }

    .chat-body {
      background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
    }

    .messages-container {
      background: rgba(30, 41, 59, 0.8);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .message.bot .message-content {
      background: #1e293b;
      color: #e2e8f0;
      border-color: #334155;
    }

    .input-container {
      background: #1e293b;
      border-color: #334155;
    }

    .chat-input {
      background: #0f172a;
      color: #e2e8f0;
      border-color: #334155;
    }

    .quick-action-btn {
      background: rgba(99, 102, 241, 0.2);
      border-color: rgba(99, 102, 241, 0.3);
      color: #c7d2fe;
    }
  }
</style>

<<<<<<< HEAD

<main>
  <div class="ai-chat-card">
    <div class="ai-chat-header card-header text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0"><i class="fas fa-robot"></i> {% trans "AI Chat Bot" %}</h4>
      <button id="clear-history" class="clear-history-btn">
        <i class="fas fa-trash-alt"></i> {% trans "Tarixni tozalash" %}
      </button>
    </div>
    <div class="ai-chat-body card-body">
      <div class="chat-messages-container" id="chat-container" style="color:black;font-weight:bold;font-size:1.11rem;letter-spacing:0.1rem">
        <!-- Xabarlar shu yerga yuklanadi -->
          {% if user.is_staff %}
            <div class="welcome-message" id="welcome-message">
              <i class="fas fa-info-circle"></i> {% trans "Sizning mutaxasisligingiz bo'yicha talabalarga yana qanday bilimlarni berishni istaysiz? Menga tushunarli tarzda savolingizni kiriting! Men sizga qiziqarli materiallarni taqdim etaman. Marhamat!" %}
            </div>
          {% else %}
            <div class="welcome-message" id="welcome-message">
              <i class="fas fa-info-circle"></i> {% trans "Siz yana o'z mutaxasislik faninggizdan nimalarni bilishni istaysiz? Tushunarli tarzda yozing, man sizga yordam beraman! Siz bergan masalaga har xil o'yinlar yoki metodlarni qo'llab tayyorlayman." %}
            </div>
          {% endif %}
      </div>
      <div class="chat-tips" style="margin-bottom: 15px;">
        <small>
          <i class="fas fa-lightbulb"></i> {% trans "Maslahat: Dasturlash, Python, Django, HTML, CSS, JavaScript haqida savol bering." %}
        </small>
      </div>

      <form id="chat-form" class="form-group">
        {% csrf_token %}
        <div class="chat-input-group">
          <input
            type="text"
            id="user-input"
            class="form-control"
            placeholder="{% trans "Savolingizni yozing..." %}"
            required
            autocomplete="off"
          />
          <button type="submit" class="chat-submit-btn">
            <i class="fas fa-paper-plane"></i> {% trans "Yuborish" %}
          </button>
=======
<main class="ai-chat-wrapper">
  <div class="ai-chat-container">
    <!-- Header -->
    <div class="chat-header">
      <div class="header-left">
        <div class="ai-avatar">
          <i class="fas fa-robot"></i>
>>>>>>> a7c825b2777f4ab901828edbc43926e4c10f16ae
        </div>
        <div class="header-info">
          <h1>ðŸ¤– AI Dasturlash Yordamchisi</h1>
          <p>Python, Django, Web va boshqa IT texnologiyalar bo'yicha maslahatchi</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="header-btn" id="theme-toggle">
          <i class="fas fa-moon"></i> Mavzu
        </button>
        <button class="header-btn danger" id="clear-history">
          <i class="fas fa-trash-alt"></i> Tozalash
        </button>
      </div>
    </div>

    <!-- Chat Body -->
    <div class="chat-body">
      <!-- Messages Container -->
      <div class="messages-container" id="chat-messages">
        <!-- Welcome Message -->
        <div class="welcome-message animate__animated animate__fadeIn">
          <div class="welcome-icon">
            <i class="fas fa-robot"></i>
          </div>
          <h3>ðŸ‘‹ Salom! Men AI yordamchisiman</h3>
          <p>
            {% if user.is_staff %}
            Sizning mutaxasisligingiz bo'yicha talabalarga yana qanday bilimlarni berishni istaysiz?
            Menga tushunarli tarzda savolingizni kiriting! Men sizga qiziqarli materiallarni taqdim etaman.
            {% else %}
            Siz yana o'z mutaxasislik faningizdan nimalarni bilishni istaysiz? Tushunarli tarzda yozing,
            men sizga yordam beraman! Siz bergan mavzuga har xil o'yinlar yoki metodlarni qo'llab tayyorlayman.
            {% endif %}
          </p>
          <div class="quick-actions" style="justify-content: center; margin-top: 20px;">
            <button class="quick-action-btn" data-question="Python nima?">Python nima?</button>
            <button class="quick-action-btn" data-question="Django qanday ishlaydi?">Django qanday ishlaydi?</button>
            <button class="quick-action-btn" data-question="HTML va CSS farqi">HTML va CSS farqi</button>
            <button class="quick-action-btn" data-question="JavaScript nimaga kerak?">JavaScript nimaga kerak?</button>
          </div>
        </div>
      </div>

      <!-- Typing Indicator -->
      <div class="typing-indicator" id="typing-indicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>

      <!-- Input Area -->
      <div class="input-container animate__animated animate__fadeInUp">
        <form class="chat-form" id="chat-form">
          {% csrf_token %}
          <div class="input-wrapper">
            <textarea
              class="chat-input"
              id="user-input"
              placeholder="{% trans "Savolingizni yozing... (Shift+Enter yangi qator)" %}"
              rows="1"
              required
            ></textarea>
            <div class="input-icons">
              <button type="button" class="input-icon" id="attach-file" title="Fayl biriktirish">
                <i class="fas fa-paperclip"></i>
              </button>
              <button type="button" class="input-icon" id="voice-input" title="Ovozli kirish">
                <i class="fas fa-microphone"></i>
              </button>
            </div>
          </div>
          <button type="submit" class="send-button" id="send-button">
            <span class="spinner"><i class="fas fa-spinner"></i></span>
            <span class="text"><i class="fas fa-paper-plane"></i> Yuborish</span>
          </button>
        </form>

        <!-- Quick Actions -->
        <div class="quick-actions">
          <button class="quick-action-btn" data-question="Kod yozishga yordam kerak">Kod yozish</button>
          <button class="quick-action-btn" data-question="Xatoni tuzatish">Xatoni tuzatish</button>
          <button class="quick-action-btn" data-question="Algoritm tushuntirish">Algoritm</button>
          <button class="quick-action-btn" data-question="SQL so'rovi">SQL so'rovi</button>
          <button class="quick-action-btn" data-question="Web dasturlash">Web dasturlash</button>
        </div>

        <!-- Status -->
        <div class="status-indicator">
          <div class="status-dot" id="status-dot"></div>
          <span id="status-text">AI yordamchi faol</span>
        </div>
      </div>
    </div>
  </div>
</main>
{% endblock %}

{% block scripts %}
<script>
  // Konfiguratsiya
  const CONFIG = {
    STORAGE_KEY: 'ai_chat_history_v2',
    MAX_HISTORY: 50,
    API_URL: window.location.pathname,
    TYPING_DELAY: 1000,
    THEME_KEY: 'ai_chat_theme'
  };

  // Elementlar
  const elements = {
    form: document.getElementById('chat-form'),
    input: document.getElementById('user-input'),
    messages: document.getElementById('chat-messages'),
    sendBtn: document.getElementById('send-button'),
    typingIndicator: document.getElementById('typing-indicator'),
    clearBtn: document.getElementById('clear-history'),
    themeToggle: document.getElementById('theme-toggle'),
    statusDot: document.getElementById('status-dot'),
    statusText: document.getElementById('status-text'),
    quickActions: document.querySelectorAll('.quick-action-btn')
  };

  // Dastur holati
  const state = {
    isTyping: false,
    isOnline: true,
    theme: localStorage.getItem(CONFIG.THEME_KEY) || 'light',
    history: []
  };

  // Dasturni ishga tushirish
  function init() {
    loadTheme();
    loadHistory();
    setupEventListeners();
    autoResizeTextarea();
    updateStatus();
    elements.input.focus();
  }

  // Matn maydonini avtomatik o'lchamlash
  function autoResizeTextarea() {
    elements.input.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });
  }

  // Tema sozlamalari
  function loadTheme() {
    document.documentElement.setAttribute('data-theme', state.theme);
    elements.themeToggle.innerHTML = state.theme === 'dark'
      ? '<i class="fas fa-sun"></i> Kun'
      : '<i class="fas fa-moon"></i> Tun';
  }

  function toggleTheme() {
    state.theme = state.theme === 'light' ? 'dark' : 'light';
    localStorage.setItem(CONFIG.THEME_KEY, state.theme);
    loadTheme();
  }

  // Chat tarixi
  function loadHistory() {
    try {
      const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
      if (saved) {
        state.history = JSON.parse(saved);
        renderHistory();
      }
    } catch (error) {
      console.error('Tarixni yuklashda xatolik:', error);
    }
  }

  function saveHistory() {
    try {
      localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(state.history));
    } catch (error) {
      console.error('Tarixni saqlashda xatolik:', error);
    }
  }

  function renderHistory() {
    if (state.history.length === 0) return;

    // Welcome xabarini yashirish
    const welcome = document.querySelector('.welcome-message');
    if (welcome) welcome.style.display = 'none';

    // Tarixni chiqarish
    state.history.forEach(msg => {
      addMessageToUI(msg.text, msg.sender, msg.type, false);
    });
  }

  function clearHistory() {
    if (!confirm('Barcha chat tarixini tozalashni istaysizmi?')) return;

    state.history = [];
    localStorage.removeItem(CONFIG.STORAGE_KEY);

    // UI ni yangilash
    elements.messages.innerHTML = '';
    const welcome = document.querySelector('.welcome-message');
    if (welcome) welcome.style.display = 'block';

    showNotification('Chat tarixi tozalandi', 'success');
    elements.input.focus();
  }

  // Xabarlarni boshqarish
  function addMessage(text, sender, type = 'normal', save = true) {
    const message = {
      text,
      sender,
      type,
      timestamp: new Date().toISOString()
    };

    if (save) {
      state.history.push(message);
      if (state.history.length > CONFIG.MAX_HISTORY) {
        state.history = state.history.slice(-CONFIG.MAX_HISTORY);
      }
      saveHistory();
    }

    addMessageToUI(text, sender, type, true);
  }

  function addMessageToUI(text, sender, type, animate = true) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender} ${animate ? 'animate__animated animate__fadeIn' : ''}`;

    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';

    // Xabar sarlavhasi
    const header = document.createElement('div');
    header.className = 'message-header';

    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.innerHTML = sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

    const senderName = document.createElement('span');
    senderName.className = 'message-sender';
    senderName.textContent = sender === 'user' ? 'Siz' : 'AI Yordamchi';

    const time = document.createElement('span');
    time.className = 'message-time';
    time.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    header.appendChild(avatar);
    header.appendChild(senderName);
    header.appendChild(time);

    // Xabar matni
    const textDiv = document.createElement('div');
    textDiv.className = 'message-text';

    // Formatlash
    const formattedText = formatMessage(text, type);
    textDiv.innerHTML = formattedText;

    // Birlashtirish
    contentDiv.appendChild(header);
    contentDiv.appendChild(textDiv);
    messageDiv.appendChild(contentDiv);

    // Chatga qo'shish
    elements.messages.appendChild(messageDiv);

    // Scroll pastga
    scrollToBottom();

    // Welcome xabarini yashirish
    const welcome = document.querySelector('.welcome-message');
    if (welcome && sender === 'user') {
      welcome.style.display = 'none';
    }
  }

  function formatMessage(text, type) {
    if (type === 'code') {
      return `<div class="message-code">
                <span class="code-language">python</span>
                ${text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
              </div>`;
    }

    if (type === 'tip') {
      return `<div class="message-tips">
                <i class="fas fa-lightbulb"></i> ${text}
              </div>`;
    }

    if (type === 'warning') {
      return `<div class="message-warning">
                <i class="fas fa-exclamation-triangle"></i> ${text}
              </div>`;
    }

    if (type === 'success') {
      return `<div class="message-success">
                <i class="fas fa-check-circle"></i> ${text}
              </div>`;
    }

    // Oddiy matn formatlash
    let formatted = text
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/\n/g, '<br>')
      .replace(/```([\s\S]*?)```/g, '<div class="message-code"><span class="code-language">code</span>$1</div>')
      .replace(/`([^`]+)`/g, '<code>$1</code>')
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>');

    return formatted;
  }

  // Serverga so'rov yuborish
  async function sendMessage(message = null) {
    const userMessage = message || elements.input.value.trim();

    if (!userMessage) {
      showNotification('Iltimos, xabar kiriting', 'warning');
      return;
    }

    // Foydalanuvchi xabarini ko'rsatish
    addMessage(userMessage, 'user');

    // Inputni tozalash va to'xtatish
    if (!message) {
      elements.input.value = '';
      elements.input.style.height = 'auto';
    }

    // Yuklanish holatini ko'rsatish
    setLoading(true);
    showTypingIndicator(true);

    try {
      const response = await fetch(CONFIG.API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({ message: userMessage }),
      });

      const data = await response.json();

      if (data.success) {
        addMessage(data.response, 'bot', data.type);
        updateStatus(true);
      } else {
        addMessage(`Xatolik: ${data.response}`, 'bot', 'warning');
        updateStatus(false);
      }

    } catch (error) {
      console.error('Xatolik:', error);
      addMessage('Server bilan bog\'lanishda xatolik. Iltimos, keyinroq urinib ko\'ring.', 'bot', 'warning');
      updateStatus(false);
    } finally {
      setLoading(false);
      showTypingIndicator(false);
      elements.input.focus();
    }
  }

  // UI holatini boshqarish
  function setLoading(isLoading) {
    elements.sendBtn.disabled = isLoading;
    elements.input.disabled = isLoading;

    if (isLoading) {
      elements.sendBtn.classList.add('loading');
    } else {
      elements.sendBtn.classList.remove('loading');
    }
  }

  function showTypingIndicator(show) {
    if (show) {
      elements.typingIndicator.classList.add('active');
      elements.typingIndicator.style.display = 'flex';
    } else {
      elements.typingIndicator.classList.remove('active');
      setTimeout(() => {
        elements.typingIndicator.style.display = 'none';
      }, 300);
    }
  }

  function updateStatus(isOnline = true) {
    state.isOnline = isOnline;

    if (isOnline) {
      elements.statusDot.className = 'status-dot';
      elements.statusText.textContent = 'AI yordamchi faol';
      elements.statusText.style.color = '';
    } else {
      elements.statusDot.className = 'status-dot offline';
      elements.statusText.textContent = 'Offline rejim';
      elements.statusText.style.color = 'var(--danger-color)';
    }
  }

  function scrollToBottom() {
    elements.messages.scrollTop = elements.messages.scrollHeight;
  }

  // Foydali funktsiyalar
  function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
  }

  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      background: ${type === 'success' ? 'var(--success-color)' : type === 'warning' ? 'var(--warning-color)' : 'var(--primary-color)'};
      color: white;
      border-radius: 12px;
      box-shadow: var(--shadow);
      z-index: 9999;
      animation: slideIn 0.3s ease-out;
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
      notification.style.animation = 'slideIn 0.3s ease-out reverse';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  // Event listenerlar
  function setupEventListeners() {
    // Form yuborish
    elements.form.addEventListener('submit', (e) => {
      e.preventDefault();
      sendMessage();
    });

    // Enter/Sift+Enter
    elements.input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Tezkor harakatlar
    elements.quickActions.forEach(btn => {
      btn.addEventListener('click', () => {
        const question = btn.getAttribute('data-question');
        sendMessage(question);
      });
    });

    // Tarixni tozalash
    elements.clearBtn.addEventListener('click', clearHistory);

    // Temani o'zgartirish
    elements.themeToggle.addEventListener('click', toggleTheme);

    // Fayl biriktirish
    document.getElementById('attach-file').addEventListener('click', () => {
      showNotification('Bu funksiya tez orada qo\'shiladi', 'info');
    });

    // Ovozli kirish
    document.getElementById('voice-input').addEventListener('click', () => {
      showNotification('Ovozli kirish tez orada qo\'shiladi', 'info');
    });

    // Scrollni kuzatish
    elements.messages.addEventListener('scroll', () => {
      const isAtBottom = elements.messages.scrollHeight - elements.messages.clientHeight <= elements.messages.scrollTop + 50;

      if (!isAtBottom) {
        // Ko'rsatkich qo'shish yoki boshqa harakatlar
      }
    });

    // Onlayn holatni tekshirish
    window.addEventListener('online', () => updateStatus(true));
    window.addEventListener('offline', () => updateStatus(false));
  }

  // Dasturni ishga tushirish
  document.addEventListener('DOMContentLoaded', init);
</script>
{% endblock %}