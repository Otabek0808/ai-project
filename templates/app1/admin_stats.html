{% extends 'base.html' %}
{% block content %}
<div class="container mt-5">
  <h1 class="text-center mb-4">Foydalanuvchilar statistikasi</h1>

  <div class="card">
    <div class="card-header bg-dark text-white">
      <h4 class="mb-0"><i class="fas fa-users"></i> Barcha foydalanuvchilar</h4>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>#</th>
              <th>Foydalanuvchi</th>
              <th>Ism Familiya</th>
              <th>Guruh</th>
              <th>Email</th>
              <th>Ro'yxatdan o'tgan sana</th>
              <th>Testlar soni</th>
              <th>O'rtacha ball</th>
              <th>Harakatlar</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>
                <strong>{{ user.username }}</strong>
              </td>
              <td>
                {% if user.userprofile.first_name or user.userprofile.last_name
                %}
                <a
                  href="{% url 'user_profile_detail' user.id %}"
                  class="text-decoration-none"
                >
                  {{ user.userprofile.first_name }} {{
                  user.userprofile.last_name }}
                </a>
                {% else %}
                <span class="text-muted">Kiritilmagan</span>
                {% endif %}
              </td>
              <td>
                {% if user.userprofile.group %}
                <span class="badge bg-primary"
                  >{{ user.userprofile.group }}</span
                >
                {% else %}
                <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td>{{ user.email|default:"-" }}</td>
              <td>{{ user.date_joined|date:"d.m.Y" }}</td>
              <td>
                <span class="badge bg-primary"
                  >{{ user.testresult_set.count }}</span
                >
              </td>
              <td>
                {% with user.testresult_set.all as results %} {% if results %}
                {% with best_result=results|dictsort:"score"|last %} {{
                best_result.percentage|floatformat:1 }}% {% endwith %} {% else
                %} - {% endif %} {% endwith %}
              </td>
              <td>
                <a
                  href="{% url 'user_stats' user.id %}"
                  class="btn btn-sm btn-outline-primary me-1"
                >
                  <i class="fas fa-chart-line"></i> Statistika
                </a>
                <a
                  href="{% url 'user_profile_detail' user.id %}"
                  class="btn btn-sm btn-outline-info"
                >
                  <i class="fas fa-user"></i> Profil
                </a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="9" class="text-center text-muted">
                Hozircha foydalanuvchilar mavjud emas
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}
