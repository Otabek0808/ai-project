{% extends 'base.html' %}
{% load i18n %}

{% block title %}Python Savol - {{ question.function_name }}{% endblock %}

{% block content %}
<style>
    /* Umumiy stillar */
    .container-fluid {
        background: transparent !important;
    }

    /* Kartalar uchun */
    .card {
        background-color: rgba(255, 255, 255, 0.511) !important;
        backdrop-filter: blur(10px);
        border: 0.1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        overflow: hidden;
    }

    /* Card header uchun */
    .python-header {
        background: linear-gradient(135deg,
            rgba(55, 118, 171, 0.8) 0%,
            rgba(48, 105, 152, 0.8) 100%) !important;
        border-bottom: 3px solid rgba(255, 212, 59, 0.8);
    }

    .python-header h6 {
        color: white !important;
        font-weight: 700;
    }

    .bg-success {
        background: linear-gradient(135deg,
            rgba(25, 135, 84, 0.8) 0%,
            rgba(21, 115, 71, 0.8) 100%) !important;
        border: none;
    }

    /* Card body uchun */
    .card-body {
        background-color: rgba(255, 255, 255, 0.511) !important;
        padding: 25px;
    }

    /* Form elementlari uchun */
    .form-control,
    .form-select,
    .input-group-text,
    textarea {
        background-color: rgba(255, 255, 255, 0.511) !important;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: rgba(55, 118, 171, 0.5) !important;
        box-shadow: 0 0 0 0.25rem rgba(55, 118, 171, 0.25) !important;
        background-color: rgba(255, 255, 255, 0.7) !important;
    }

    /* Buttonlar uchun */
    .btn {
        backdrop-filter: blur(10px);
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        padding: 10px 20px;
    }

    .btn-primary {
        background: linear-gradient(135deg,
            rgba(55, 118, 171, 0.9) 0%,
            rgba(48, 105, 152, 0.9) 100%) !important;
        border: none;
        color: white;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg,
            rgba(48, 105, 152, 0.9) 0%,
            rgba(55, 118, 171, 0.9) 100%) !important;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(55, 118, 171, 0.3);
    }

    .btn-warning {
        background: linear-gradient(135deg,
            rgba(255, 193, 7, 0.9) 0%,
            rgba(253, 126, 20, 0.9) 100%) !important;
        border: none;
        color: #333;
    }

    .btn-warning:hover {
        background: linear-gradient(135deg,
            rgba(253, 126, 20, 0.9) 0%,
            rgba(255, 193, 7, 0.9) 100%) !important;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255, 193, 7, 0.3);
    }

    .btn-outline-info {
        background: rgba(255, 255, 255, 0.5);
        border: 2px solid rgba(13, 202, 240, 0.5);
        color: #0dcaf0;
    }

    .btn-outline-info:hover {
        background: rgba(13, 202, 240, 0.1);
        border-color: #0dcaf0;
        color: #0dcaf0;
        transform: translateY(-2px);
    }

    .btn-outline-secondary {
        background: rgba(255, 255, 255, 0.5);
        border: 2px solid rgba(108, 117, 125, 0.3);
        color: #6c757d;
    }

    .btn-outline-secondary:hover {
        background: rgba(108, 117, 125, 0.1);
        border-color: #6c757d;
        color: #6c757d;
        transform: translateY(-2px);
    }

    /* Alert xabarlari */
    .alert {
        background-color: rgba(255, 255, 255, 0.511);
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 10px;
        backdrop-filter: blur(10px);
    }

    .alert-warning {
        border-left: 4px solid rgba(255, 193, 7, 0.8);
    }

    .alert-info {
        border-left: 4px solid rgba(13, 202, 240, 0.8);
    }

    .alert-primary {
        background: linear-gradient(135deg,
            rgba(55, 118, 171, 0.1) 0%,
            rgba(48, 105, 152, 0.1) 100%);
        border: 1px solid rgba(55, 118, 171, 0.3);
    }

    /* Kod editori */
    #codeEditor {
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.5;
        min-height: 350px;
        resize: vertical;
        background: rgba(255, 255, 255, 0.8) !important;
        border: 2px solid rgba(255, 255, 255, 0.4) !important;
        border-radius: 8px;
        padding: 15px;
        transition: all 0.3s ease;
    }

    #codeEditor:focus {
        border-color: rgba(55, 118, 171, 0.6) !important;
        box-shadow: 0 0 0 0.25rem rgba(55, 118, 171, 0.25) !important;
        background: rgba(255, 255, 255, 0.9) !important;
    }

    /* Kod misoli */
    pre {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 15px;
        overflow-x: auto;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.4;
    }

    code.language-python {
        color: #e83e8c;
    }

    .bg-dark {
        background: #2c3e50 !important;
        color: #ecf0f1 !important;
        border-radius: 6px;
        padding: 10px;
    }

    /* Badge stillari */
    .badge {
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: 500;
        font-size: 0.85rem;
        backdrop-filter: blur(5px);
    }

    .bg-success {
        background: linear-gradient(135deg,
            rgba(40, 167, 69, 0.9) 0%,
            rgba(32, 201, 151, 0.9) 100%) !important;
    }

    .bg-warning {
        background: linear-gradient(135deg,
            rgba(255, 193, 7, 0.9) 0%,
            rgba(253, 126, 20, 0.9) 100%) !important;
        color: #333;
    }

    .bg-danger {
        background: linear-gradient(135deg,
            rgba(220, 53, 69, 0.9) 0%,
            rgba(187, 45, 59, 0.9) 100%) !important;
    }

    .bg-primary {
        background: linear-gradient(135deg,
            rgba(55, 118, 171, 0.9) 0%,
            rgba(48, 105, 152, 0.9) 100%) !important;
    }

    .bg-info {
        background: linear-gradient(135deg,
            rgba(13, 202, 240, 0.9) 0%,
            rgba(12, 182, 216, 0.9) 100%) !important;
    }

    .bg-secondary {
        background: linear-gradient(135deg,
            rgba(108, 117, 125, 0.9) 0%,
            rgba(73, 80, 87, 0.9) 100%) !important;
    }

    /* List group */
    .list-group-item {
        background-color: rgba(255, 255, 255, 0.3);
        border: 1px solid rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }

    .list-group-item:hover {
        background-color: rgba(55, 118, 171, 0.05);
        transform: translateX(5px);
    }

    /* Responsive dizayn */
    @media (max-width: 992px) {
        .col-lg-5, .col-lg-7 {
            width: 100%;
            margin-bottom: 20px;
        }

        .card-body {
            padding: 20px;
        }

        .btn {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        #codeEditor {
            min-height: 300px;
            font-size: 13px;
        }
    }

    @media (max-width: 768px) {
        .card-body {
            padding: 15px;
        }

        .btn-group {
            flex-wrap: wrap;
            gap: 10px;
        }

        .btn {
            margin-bottom: 5px;
        }

        #codeEditor {
            min-height: 250px;
            font-size: 12px;
        }

        .badge {
            padding: 6px 12px;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
    }

    @media (max-width: 576px) {
        .container-fluid {
            padding: 0 10px !important;
        }

        .card {
            border-radius: 8px;
        }

        .card-body {
            padding: 12px;
        }

        .btn {
            width: 100%;
            margin-bottom: 10px;
            justify-content: center;
        }

        .d-flex.justify-content-between {
            flex-direction: column;
            gap: 10px;
        }

        #codeEditor {
            min-height: 200px;
            font-size: 11px;
        }

        .alert {
            padding: 10px;
        }
    }

    /* Animatsiyalar */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .card {
        animation: fadeIn 0.5s ease-out;
    }

    /* SweetAlert2 uchun maxsus stillar */
    .swal2-popup {
        background: rgba(255, 255, 255, 0.95) !important;
        backdrop-filter: blur(20px);
        border-radius: 15px !important;
        border: 2px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2) !important;
    }

    .swal2-title {
        color: #2c3e50 !important;
        font-weight: 700 !important;
    }

    .swal2-content {
        color: #495057 !important;
    }

    /* Kod formati uchun */
    .font-monospace {
        font-family: 'Courier New', monospace !important;
    }

    /* Funksiya eslatmasi uchun maxsus stillar */
    .border-primary {
        border-color: rgba(55, 118, 171, 0.5) !important;
    }

    /* Scrollbar stillari */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.05);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg,
            rgba(55, 118, 171, 0.6) 0%,
            rgba(255, 212, 59, 0.6) 100%);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg,
            rgba(55, 118, 171, 0.8) 0%,
            rgba(255, 212, 59, 0.8) 100%);
    }
</style>

<div class="container-fluid py-4">
    <div class="row">
        <!-- Savol qismi -->
        <div class="col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3 python-header">
                    <h6 class="m-0 font-weight-bold text-white">
                        <i class="fab fa-python me-2"></i>
                        {% trans "Python Savol" %}
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Savol matni -->
                    <div class="mb-4">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-question-circle me-2"></i>
                            {% trans "Savol" %}
                        </h5>
                        <div class="p-3 bg-light rounded border">
                            {{ question.question_text|linebreaks }}
                        </div>
                    </div>

                    <!-- Funksiya talablari -->
                    <div class="card border-primary mb-4">
                        <div class="card-header bg-primary text-white py-2">
                            <h6 class="mb-0">
                                <i class="fas fa-code me-2"></i>
                                {% trans "Funksiya Talablari" %}
                            </h6>
                        </div>
                        <div class="card-body p-3">
                            <div class="alert alert-warning">
                                <h6 class="alert-heading mb-2">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    {% trans "MUHIM: Quyidagi funksiyani yozishingiz kerak" %}
                                </h6>
                                <div class="bg-dark text-light p-3 rounded font-monospace">
                                    def {{ question.function_name }}({{ question.function_params }}):
                                </div>
                            </div>

                            <div class="mt-3">
                                <h6 class="text-success mb-2">
                                    <i class="fas fa-check-circle me-2"></i>
                                    {% trans "Qoidalar:" %}
                                </h6>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item">
                                        <i class="fas fa-arrow-right text-primary me-2"></i>
                                        {% blocktrans %}Funksiya nomi <code>{{ question.function_name }}</code> bo'lishi shart{% endblocktrans %}
                                    </li>
                                    <li class="list-group-item">
                                        <i class="fas fa-arrow-right text-primary me-2"></i>
                                        {% blocktrans %}Parametrlar <code>{{ question.function_params }}</code> bo'lishi shart{% endblocktrans %}
                                    </li>
                                    <li class="list-group-item">
                                        <i class="fas fa-arrow-right text-primary me-2"></i>
                                        {% trans "Natijani <code>return</code> bilan qaytaring" %}
                                    </li>
                                    <li class="list-group-item">
                                        <i class="fas fa-arrow-right text-primary me-2"></i>
                                        {% trans "<code>print()</code> ishlatish shart emas" %}
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Savol ma'lumotlari -->
                    <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                        <div>
                            <span class="badge {% if question.difficulty == 'easy' %}bg-success{% elif question.difficulty == 'medium' %}bg-warning{% else %}bg-danger{% endif %} me-2">
                                {{ question.get_difficulty_display }}
                            </span>
                            <span class="badge bg-primary">
                                <i class="fab fa-python me-1"></i>{% trans "Python" %}
                            </span>
                            {% if question.category %}
                            <span class="badge bg-info ms-2">
                                {{ question.category }}
                            </span>
                            {% endif %}
                            <span class="badge bg-secondary ms-2">
                                {% blocktrans %}{{ question.points }} ball{% endblocktrans %}
                            </span>
                        </div>
                        <small class="text-muted">
                            <i class="far fa-clock me-1"></i>
                            {{ question.created_at|date:"d.m.Y H:i" }}
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Kod editori -->
        <div class="col-lg-7">
            <div class="card shadow h-100">
                <div class="card-header py-3 bg-success text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-edit me-2"></i>
                        {% trans "Python Kod Editori" %}
                    </h6>
                </div>
                <div class="card-body p-0 d-flex flex-column">
                    <form method="post" id="codeForm" class="d-flex flex-column flex-grow-1">
                        {% csrf_token %}

                        <!-- Funksiya eslatmasi -->
                        <div class="alert alert-info m-3 mb-0">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-info-circle fa-2x me-3 text-info"></i>
                                <div>
                                    <strong>{% trans "Eslatma:" %}</strong>
                                    {% blocktrans %}Siz <code class="bg-dark text-light px-2 py-1">{{ question.function_name }}({{ question.function_params }})</code>
                                    funksiyasini yozishingiz kerak.{% endblocktrans %}
                                </div>
                            </div>
                        </div>

                        <!-- Kod editori -->
                        <div class="p-3 flex-grow-1">
                            <label class="form-label fw-bold mb-2">
                                <i class="fas fa-code me-2"></i>
                                {% trans "Python kodingizni yozing:" %}
                            </label>
                            <textarea
                                name="code"
                                id="codeEditor"
                                rows="15"
                                class="form-control font-monospace"
                                style="font-size: 14px; min-height: 300px;"
                                placeholder="{% trans "Python kodini bu yerga yozing..." %}"
                            >{{ initial_code }}</textarea>

                            <!-- Kod misoli -->
                            <div class="mt-3">
                                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#codeExample">
                                    <i class="fas fa-eye me-1"></i>{% trans "Kod misolini ko'rsatish" %}
                                </button>

                                <div id="codeExample" class="collapse mt-2">
                                    <div class="card">
                                        <div class="card-body p-2">
                                            <pre class="mb-0"><code class="language-python">def {{ question.function_name }}({{ question.function_params }}):
    """
    Bu funksiya {{ question.function_name }} deb nomlanishi kerak.
    Funksiya {{ question.function_params }} parametrlarini qabul qiladi.
    Natijani return bilan qaytaradi.
    """

    # YECHIMNI YOZING
    # Masalan: return a + b  # qo'shish uchun
    # yoki:    return a * b  # ko'paytirish uchun

    return None  # O'rniga haqiqiy natijani qaytaring</code></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tugmalar -->
                        <div class="p-3 border-top bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button type="button" class="btn btn-outline-info btn-sm" id="formatBtn">
                                        <i class="fas fa-indent me-1"></i>{% trans "Format" %}
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="clearBtn">
                                        <i class="fas fa-broom me-1"></i>{% trans "Tozalash" %}
                                    </button>
                                    <button type="button" class="btn btn-warning btn-sm ms-2" id="testBtn">
                                        <i class="fas fa-play me-1"></i>{% trans "Test qilish" %}
                                    </button>
                                </div>
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-paper-plane me-1"></i>{% trans "Yuborish va test qilish" %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
$(document).ready(function() {
    var editor = $('#codeEditor');
    var questionFunction = "{{ question.function_name }}";
    var questionParams = "{{ question.function_params }}";

    // Format tugmasi
    $('#formatBtn').click(function() {
        var code = editor.val();

        // Python indentatsiya qilish
        var lines = code.split('\n');
        var formatted = [];
        var indent = 0;

        for (var i = 0; i < lines.length; i++) {
            var line = lines[i].trim();

            if (line === '') {
                formatted.push('');
                continue;
            }

            // Funksiya tanasi
            if (line.startsWith('def ' + questionFunction + '(')) {
                formatted.push(line);
                indent = 1;
            }
            // Return statement
            else if (line.startsWith('return ')) {
                formatted.push('    ' + line);
            }
            // Comment
            else if (line.startsWith('#')) {
                formatted.push('    ' + line);
            }
            // Boshqa kod
            else {
                formatted.push('    ' + line);
            }
        }

        editor.val(formatted.join('\n'));
    });

    // Tozalash tugmasi - YANGILANGAN
    $('#clearBtn').click(function() {
        Swal.fire({
            title: 'Kodni tozalash',
            text: 'Barcha yozilgan kod o\'chib ketadi. Davom etishni istaysizmi?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ha, tozalash',
            cancelButtonText: 'Bekor qilish'
        }).then((result) => {
            if (result.isConfirmed) {
                // Tozalash
                var initialCode = `def {{ question.function_name }}({{ question.function_params }}):\n    # Yechimni yozing\n    return None`;
                editor.val(initialCode);

                // Xabar ko'rsatish
                Swal.fire(
                    'Tozalandi!',
                    'Kod tozalandi. Endi yangi kod yozishingiz mumkin.',
                    'success'
                );
            }
        });
    });

    // Test qilish tugmasi (AJAX)
    $('#testBtn').click(function() {
        var code = editor.val().trim();

        if (!code) {
            Swal.fire({
                icon: 'error',
                title: 'Xatolik',
                text: 'Kod kiritilmagan!',
                confirmButtonText: 'OK'
            });
            return;
        }

        // Funksiya nomini tekshirish
        if (code.indexOf('def {{ question.function_name }}') === -1) {
            Swal.fire({
                icon: 'error',
                title: 'Xatolik',
                html: `Siz '<strong>{{ question.function_name }}</strong>' funksiyasini yozishingiz kerak!<br><br>` +
                      `To'g'ri format: <code>def {{ question.function_name }}({{ question.function_params }})</code>`,
                confirmButtonText: 'Tushunarli'
            });
            return;
        }

        // AJAX so'rov
        $.ajax({
            url: '{% url "app2:run_test" %}',
            method: 'POST',
            data: {
                'code': code,
                'question_id': {{ question.id }},
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            beforeSend: function() {
                $('#testBtn').html('<i class="fas fa-spinner fa-spin me-1"></i>Test qilinmoqda...');
                $('#testBtn').prop('disabled', true);
            },
            success: function(response) {
                if (response.success) {
                    showTestResult(response.result);
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Xato',
                        text: response.message,
                        confirmButtonText: 'OK'
                    });
                }
            },
            error: function(xhr) {
                Swal.fire({
                    icon: 'error',
                    title: 'Server xatosi',
                    text: 'Server bilan bog\'lanishda xatolik',
                    confirmButtonText: 'OK'
                });
            },
            complete: function() {
                $('#testBtn').html('<i class="fas fa-play me-1"></i>Test qilish');
                $('#testBtn').prop('disabled', false);
            }
        });
    });

    // Formani yuborishdan oldin tekshirish
    $('#codeForm').submit(function(e) {
        var code = editor.val().trim();

        if (!code) {
            e.preventDefault();
            Swal.fire({
                icon: 'error',
                title: 'Xatolik',
                text: 'Kod kiritilmagan!',
                confirmButtonText: 'OK'
            });
            return false;
        }

        // Funksiya nomini tekshirish
        if (code.indexOf('def {{ question.function_name }}') === -1) {
            e.preventDefault();
            Swal.fire({
                icon: 'error',
                title: 'Xatolik',
                html: `Siz '<strong>{{ question.function_name }}</strong>' funksiyasini yozishingiz kerak!<br><br>` +
                      `To'g'ri format: <code>def {{ question.function_name }}({{ question.function_params }})</code>`,
                confirmButtonText: 'Tushunarli'
            });
            return false;
        }

        return true;
    });

    // Test natijasini ko'rsatish funksiyasi
    function showTestResult(result) {
        var icon = 'info';
        var title = 'Test Natijasi';
        var statusText = result.status.toUpperCase();

        if (result.status === 'success') {
            icon = 'success';
            title = '✅ SUCCESS';
        } else if (result.status === 'failed') {
            icon = 'warning';
            title = '❌ TEST FAILED';
        } else {
            icon = 'error';
            title = '⚠️  ERROR';
        }

        var html = `
        <div class="text-start">
            <div class="mb-3">
                <strong>Status:</strong>
                <span class="badge ${result.status === 'success' ? 'bg-success' : result.status === 'failed' ? 'bg-warning' : 'bg-danger'}">
                    ${statusText}
                </span>
            </div>

            <div class="mb-3">
                <strong>Ish vaqti:</strong> ${result.execution_time} soniya
            </div>

            ${result.message ? `
            <div class="mb-3">
                <strong>Xabar:</strong>
                <div class="alert alert-info p-2 mt-1">
                    <pre class="mb-0">${result.message}</pre>
                </div>
            </div>` : ''}

            ${result.output ? `
            <div class="mb-3">
                <strong>Chiqish:</strong>
                <div class="bg-dark text-light p-3 rounded mt-1" style="max-height: 200px; overflow-y: auto;">
                    <pre class="mb-0">${result.output}</pre>
                </div>
            </div>` : '<p><em>Hech qanday chiqish yo\'q</em></p>'}
        </div>`;

        Swal.fire({
            title: title,
            html: html,
            icon: icon,
            width: 800,
            confirmButtonText: 'OK'
        });
    }

    // Kod editoriga avtomatik focus
    editor.focus();
});
</script>
{% endblock %}