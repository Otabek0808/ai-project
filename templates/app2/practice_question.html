{% extends 'base.html' %}
{% load static %}

{% block title %}Python Savol - {{ question.function_name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Savol qismi -->
        <div class="col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3 python-header">
                    <h6 class="m-0 font-weight-bold text-white">
                        <i class="fab fa-python me-2"></i>
                        Python Savol
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Savol matni -->
                    <div class="mb-4">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-question-circle me-2"></i>
                            Savol
                        </h5>
                        <div class="p-3 bg-light rounded border">
                            {{ question.question_text|linebreaks }}
                        </div>
                    </div>

                    <!-- Funksiya talablari -->
                    <div class="card border-primary mb-4">
                        <div class="card-header bg-primary text-white py-2">
                            <h6 class="mb-0">
                                <i class="fas fa-code me-2"></i>
                                Funksiya Talablari
                            </h6>
                        </div>
                        <div class="card-body p-3">
                            <div class="alert alert-warning">
                                <h6 class="alert-heading mb-2">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    MUHIM: Quyidagi funksiyani yozishingiz kerak
                                </h6>
                                <div class="bg-dark text-light p-3 rounded font-monospace">
                                    def {{ question.function_name }}({{ question.function_params }}):
                                </div>
                            </div>

                            <div class="mt-3">
                                <h6 class="text-success mb-2">
                                    <i class="fas fa-check-circle me-2"></i>
                                    Qoidalar:
                                </h6>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item">
                                        <i class="fas fa-arrow-right text-primary me-2"></i>
                                        Funksiya nomi <code>{{ question.function_name }}</code> bo'lishi shart
                                    </li>
                                    <li class="list-group-item">
                                        <i class="fas fa-arrow-right text-primary me-2"></i>
                                        Parametrlar <code>{{ question.function_params }}</code> bo'lishi shart
                                    </li>
                                    <li class="list-group-item">
                                        <i class="fas fa-arrow-right text-primary me-2"></i>
                                        Natijani <code>return</code> bilan qaytaring
                                    </li>
                                    <li class="list-group-item">
                                        <i class="fas fa-arrow-right text-primary me-2"></i>
                                        <code>print()</code> ishlatish shart emas
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Savol ma'lumotlari -->
                    <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                        <div>
                            <span class="badge {% if question.difficulty == 'easy' %}bg-success{% elif question.difficulty == 'medium' %}bg-warning{% else %}bg-danger{% endif %} me-2">
                                {{ question.get_difficulty_display }}
                            </span>
                            <span class="badge bg-primary">
                                <i class="fab fa-python me-1"></i>Python
                            </span>
                            {% if question.category %}
                            <span class="badge bg-info ms-2">
                                {{ question.category }}
                            </span>
                            {% endif %}
                            <span class="badge bg-secondary ms-2">
                                {{ question.points }} ball
                            </span>
                        </div>
                        <small class="text-muted">
                            <i class="far fa-clock me-1"></i>
                            {{ question.created_at|date:"d.m.Y H:i" }}
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Kod editori -->
        <div class="col-lg-7">
            <div class="card shadow h-100">
                <div class="card-header py-3 bg-success text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-edit me-2"></i>
                        Python Kod Editori
                    </h6>
                </div>
                <div class="card-body p-0 d-flex flex-column">
                    <form method="post" id="codeForm" class="d-flex flex-column flex-grow-1">
                        {% csrf_token %}

                        <!-- Funksiya eslatmasi -->
                        <div class="alert alert-info m-3 mb-0">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-info-circle fa-2x me-3 text-info"></i>
                                <div>
                                    <strong>Eslatma:</strong>
                                    Siz <code class="bg-dark text-light px-2 py-1">{{ question.function_name }}({{ question.function_params }})</code>
                                    funksiyasini yozishingiz kerak.
                                </div>
                            </div>
                        </div>

                        <!-- Kod editori -->
                        <div class="p-3 flex-grow-1">
                            <label class="form-label fw-bold mb-2">
                                <i class="fas fa-code me-2"></i>
                                Python kodingizni yozing:
                            </label>
                            <textarea
                                name="code"
                                id="codeEditor"
                                rows="15"
                                class="form-control font-monospace"
                                style="font-size: 14px; min-height: 300px;"
                                placeholder="Python kodini bu yerga yozing..."
                            >{{ initial_code }}</textarea>

                            <!-- Kod misoli -->
                            <div class="mt-3">
                                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#codeExample">
                                    <i class="fas fa-eye me-1"></i>Kod misolini ko'rsatish
                                </button>

                                <div id="codeExample" class="collapse mt-2">
                                    <div class="card">
                                        <div class="card-body p-2">
                                            <pre class="mb-0"><code class="language-python">def {{ question.function_name }}({{ question.function_params }}):
    """
    Bu funksiya {{ question.function_name }} deb nomlanishi kerak.
    Funksiya {{ question.function_params }} parametrlarini qabul qiladi.
    Natijani return bilan qaytaradi.
    """

    # YECHIMNI YOZING
    # Masalan: return a + b  # qo'shish uchun
    # yoki:    return a * b  # ko'paytirish uchun

    return None  # O'rniga haqiqiy natijani qaytaring</code></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tugmalar -->
                        <div class="p-3 border-top bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button type="button" class="btn btn-outline-info btn-sm" id="formatBtn">
                                        <i class="fas fa-indent me-1"></i>Format
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="clearBtn">
                                        <i class="fas fa-broom me-1"></i>Tozalash
                                    </button>
                                    <button type="button" class="btn btn-warning btn-sm ms-2" id="testBtn">
                                        <i class="fas fa-play me-1"></i>Test qilish
                                    </button>
                                </div>
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-paper-plane me-1"></i>Yuborish va test qilish
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
$(document).ready(function() {
    var editor = $('#codeEditor');
    var questionFunction = "{{ question.function_name }}";
    var questionParams = "{{ question.function_params }}";

    // Format tugmasi
    $('#formatBtn').click(function() {
        var code = editor.val();

        // Python indentatsiya qilish
        var lines = code.split('\n');
        var formatted = [];
        var indent = 0;

        for (var i = 0; i < lines.length; i++) {
            var line = lines[i].trim();

            if (line === '') {
                formatted.push('');
                continue;
            }

            // Funksiya tanasi
            if (line.startsWith('def ' + questionFunction + '(')) {
                formatted.push(line);
                indent = 1;
            }
            // Return statement
            else if (line.startsWith('return ')) {
                formatted.push('    ' + line);
            }
            // Comment
            else if (line.startsWith('#')) {
                formatted.push('    ' + line);
            }
            // Boshqa kod
            else {
                formatted.push('    ' + line);
            }
        }

        editor.val(formatted.join('\n'));
    });

    // Tozalash tugmasi - YANGILANGAN
    $('#clearBtn').click(function() {
        Swal.fire({
            title: 'Kodni tozalash',
            text: 'Barcha yozilgan kod o\'chib ketadi. Davom etishni istaysizmi?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ha, tozalash',
            cancelButtonText: 'Bekor qilish'
        }).then((result) => {
            if (result.isConfirmed) {
                // Tozalash
                var initialCode = `def {{ question.function_name }}({{ question.function_params }}):\n    # Yechimni yozing\n    return None`;
                editor.val(initialCode);

                // Xabar ko'rsatish
                Swal.fire(
                    'Tozalandi!',
                    'Kod tozalandi. Endi yangi kod yozishingiz mumkin.',
                    'success'
                );
            }
        });
    });

    // Test qilish tugmasi (AJAX)
    $('#testBtn').click(function() {
        var code = editor.val().trim();

        if (!code) {
            Swal.fire({
                icon: 'error',
                title: 'Xatolik',
                text: 'Kod kiritilmagan!',
                confirmButtonText: 'OK'
            });
            return;
        }

        // Funksiya nomini tekshirish
        if (code.indexOf('def {{ question.function_name }}') === -1) {
            Swal.fire({
                icon: 'error',
                title: 'Xatolik',
                html: `Siz '<strong>{{ question.function_name }}</strong>' funksiyasini yozishingiz kerak!<br><br>` +
                      `To'g'ri format: <code>def {{ question.function_name }}({{ question.function_params }})</code>`,
                confirmButtonText: 'Tushunarli'
            });
            return;
        }

        // AJAX so'rov
        $.ajax({
            url: '{% url "app2:run_test" %}',
            method: 'POST',
            data: {
                'code': code,
                'question_id': {{ question.id }},
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            beforeSend: function() {
                $('#testBtn').html('<i class="fas fa-spinner fa-spin me-1"></i>Test qilinmoqda...');
                $('#testBtn').prop('disabled', true);
            },
            success: function(response) {
                if (response.success) {
                    showTestResult(response.result);
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Xato',
                        text: response.message,
                        confirmButtonText: 'OK'
                    });
                }
            },
            error: function(xhr) {
                Swal.fire({
                    icon: 'error',
                    title: 'Server xatosi',
                    text: 'Server bilan bog\'lanishda xatolik',
                    confirmButtonText: 'OK'
                });
            },
            complete: function() {
                $('#testBtn').html('<i class="fas fa-play me-1"></i>Test qilish');
                $('#testBtn').prop('disabled', false);
            }
        });
    });

    // Formani yuborishdan oldin tekshirish
    $('#codeForm').submit(function(e) {
        var code = editor.val().trim();

        if (!code) {
            e.preventDefault();
            Swal.fire({
                icon: 'error',
                title: 'Xatolik',
                text: 'Kod kiritilmagan!',
                confirmButtonText: 'OK'
            });
            return false;
        }

        // Funksiya nomini tekshirish
        if (code.indexOf('def {{ question.function_name }}') === -1) {
            e.preventDefault();
            Swal.fire({
                icon: 'error',
                title: 'Xatolik',
                html: `Siz '<strong>{{ question.function_name }}</strong>' funksiyasini yozishingiz kerak!<br><br>` +
                      `To'g'ri format: <code>def {{ question.function_name }}({{ question.function_params }})</code>`,
                confirmButtonText: 'Tushunarli'
            });
            return false;
        }

        return true;
    });

    // Test natijasini ko'rsatish funksiyasi
    function showTestResult(result) {
        var icon = 'info';
        var title = 'Test Natijasi';
        var statusText = result.status.toUpperCase();

        if (result.status === 'success') {
            icon = 'success';
            title = '✅ SUCCESS';
        } else if (result.status === 'failed') {
            icon = 'warning';
            title = '❌ TEST FAILED';
        } else {
            icon = 'error';
            title = '⚠️  ERROR';
        }

        var html = `
        <div class="text-start">
            <div class="mb-3">
                <strong>Status:</strong>
                <span class="badge ${result.status === 'success' ? 'bg-success' : result.status === 'failed' ? 'bg-warning' : 'bg-danger'}">
                    ${statusText}
                </span>
            </div>

            <div class="mb-3">
                <strong>Ish vaqti:</strong> ${result.execution_time} soniya
            </div>

            ${result.message ? `
            <div class="mb-3">
                <strong>Xabar:</strong>
                <div class="alert alert-info p-2 mt-1">
                    <pre class="mb-0">${result.message}</pre>
                </div>
            </div>` : ''}

            ${result.output ? `
            <div class="mb-3">
                <strong>Chiqish:</strong>
                <div class="bg-dark text-light p-3 rounded mt-1" style="max-height: 200px; overflow-y: auto;">
                    <pre class="mb-0">${result.output}</pre>
                </div>
            </div>` : '<p><em>Hech qanday chiqish yo\'q</em></p>'}
        </div>`;

        Swal.fire({
            title: title,
            html: html,
            icon: icon,
            width: 800,
            confirmButtonText: 'OK'
        });
    }

    // Kod editoriga avtomatik focus
    editor.focus();
});
</script>
{% endblock %}